<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda do Fofo</title>
  <style>
    /* Seu CSS original vem aqui - Nenhuma mudan√ßa necess√°ria */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #fff;
      color: #000;
    }
    .container {
      display: flex;
      flex-direction: column;
    }
    @media (min-width: 768px) {
      .container {
        flex-direction: row;
        min-height: 100vh;
      }
    }
    .left-panel,
    .right-panel {
      padding: 20px;
    }
    .left-panel {
      flex: 2;
      border-right: 1px solid #ccc;
    }
    .right-panel {
      flex: 1;
    }
    .calendar-section {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .calendar-section button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .day-nav {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: -10px 0 10px 0;
    }
    .day-nav button {
      padding: 2px 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .search-area {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-area input {
      flex: 1;
      padding: 5px;
      min-width: 120px;
    }
    .search-results {
      background-color: #fff;
      border: 1px solid transparent;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    .search-results div {
      cursor: pointer;
      padding: 4px;
    }
    .search-results div:hover {
      background-color: #eee;
    }
    .destaque {
      background: yellow;
    }
    .commitment {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      flex-wrap: wrap;
      padding: 5px;
    }
    .commitment input[type="text"] {
      flex: 1;
      padding: 5px;
      margin-right: 5px;
      min-width: 120px;
    }
    .commitment button {
      margin-left: 3px;
    }
    .done {
      text-decoration: line-through;
      color: gray;
    }
    #cpfStatus.valid {
      color: blue;
    }
    #cpfStatus.invalid {
      color: red;
    }
    .commitment.checked {
      background-color: #d1e7ff;
    }
    .commitment:nth-child(even) {
      background-color: #f2f2f2;
    }
    .commitment:nth-child(even).checked {
      background-color: #aed6f1;
    }
  </style>

  <!-- Adiciona os Scripts do Firebase (vers√£o de compatibilidade, mais f√°cil de usar aqui) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <!-- SEU HTML ORIGINAL VEM AQUI - NENHUMA MUDAN√áA NECESS√ÅRIA -->
  <div class="container">
    <div class="left-panel">
      <h1>Agenda do Fofo</h1>
      <div class="calendar-section">
        <input type="date" id="dataSelecionada" />
        <button id="hojeBtn" title="Hoje">üìÖ</button>
      </div>
      <div class="day-nav">
        <button id="prevDayBtn" title="Dia anterior">‚óÄ</button>
        <button id="nextDayBtn" title="Pr√≥ximo dia">‚ñ∂</button>
      </div>
      <div class="actions">
        <button id="novoBtn">Novo</button>
        <button id="copiarBtn">Copiar</button>
        <button id="colarBtn">Colar</button>
       <a href="https://luizcezarmelo.github.io/minha-agenda/laudosipi.html" target="_blank" style="text-decoration: none">
  <button type="button">Laudos de IPI</button>
</a>
      </div>
      <div id="agenda"></div>
    </div>
    <div class="right-panel">
      <h2>Validador de CPF</h2>
      <div style="display: flex; gap: 5px; flex-wrap: wrap">
        <input type="text" id="cpf" placeholder="Digite o CPF" />
        <button onclick="limparCPF()" title="Limpar CPF">‚ùå</button>
      </div>
      <p id="cpfStatus"></p>
      <button onclick="copiarCPF()">Copiar</button>

      <h3>üîç Pesquisa</h3>
      <div class="search-area">
        <input type="text" id="search" placeholder="Pesquisar..." />
        <button onclick="limparBusca()">‚ùå</button>
      </div>
      <div id="searchResults" class="search-results"></div>
      <h3>üìù Lembretes:</h3>
      <textarea
        id="notasFixas"
        rows="20"
        style="width: 100%; resize: vertical"
      ></textarea>
    </div>
  </div>

  <script>
    // ‚úÖ SUA CONFIGURA√á√ÉO DO FIREBASE J√Å EST√Å INCLU√çDA AQUI
    const firebaseConfig = {
      apiKey: "AIzaSyDQOGFiqafMZh0ha6XW62P1DpIKJE8TBYc",
      authDomain: "agenda-online-7b71c.firebaseapp.com",
      // Adicionei a databaseURL que √© necess√°ria para o Realtime Database
      databaseURL: "https://agenda-online-7b71c-default-rtdb.firebaseio.com",
      projectId: "agenda-online-7b71c",
      storageBucket: "agenda-online-7b71c.appspot.com",
      messagingSenderId: "28125733214",
      appId: "1:28125733214:web:162d1cce5d14f55c24afcf",
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Elementos principais e vari√°veis globais
    const agendaEl = document.getElementById("agenda");
    const searchEl = document.getElementById("search");
    const searchResultsEl = document.getElementById("searchResults");
    const dataInput = document.getElementById("dataSelecionada");
    const novoBtn = document.getElementById("novoBtn");
    const copiarBtn = document.getElementById("copiarBtn");
    const colarBtn = document.getElementById("colarBtn");
    const exportarBtn = document.getElementById("exportarBtn");
    const hojeBtn = document.getElementById("hojeBtn");
    const prevDayBtn = document.getElementById("prevDayBtn");
    const nextDayBtn = document.getElementById("nextDayBtn");
    const notasFixasEl = document.getElementById("notasFixas");

    const maxCompromissos = 20;
    let bufferCopiados = [];

    /* Configura√ß√£o inicial */
    dataInput.value = new Date().toISOString().split("T")[0];
    window.addEventListener("load", () => {
      carregarAgenda();
      carregarNotasFixas(); // Carrega as notas fixas ao iniciar
    });

    /* Listeners de interface */
    dataInput.addEventListener("change", carregarAgenda);
    novoBtn.addEventListener("click", adicionarCompromisso);
    copiarBtn.addEventListener("click", copiarCompromissos);
    colarBtn.addEventListener("click", colarCompromissos);
    // Removi exportarBtn (j√° n√£o existe) e coloquei o bot√£o Laudos de IPI com link
    hojeBtn.addEventListener("click", () => {
      const hoje = new Date().toISOString().split("T")[0];
      dataInput.value = hoje;
      carregarAgenda();
    });
    prevDayBtn.addEventListener("click", () => {
      const d = new Date(dataInput.value);
      d.setDate(d.getDate() - 1);
      dataInput.value = d.toISOString().split("T")[0];
      carregarAgenda();
    });
    nextDayBtn.addEventListener("click", () => {
      const d = new Date(dataInput.value);
      d.setDate(d.getDate() + 1);
      dataInput.value = d.toISOString().split("T")[0];
      carregarAgenda();
    });
    searchEl.addEventListener("input", pesquisarCompromisso);

    /* Salvamento com delay */
    let debounceTimer;
    function salvarComDelay() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => salvarAgenda(), 1000); // Aumentei um pouco o delay para redes
    }

    /* Carregar agenda do dia selecionado */
    async function carregarAgenda() {
      const data = dataInput.value;
      agendaEl.innerHTML = ""; // Limpa a agenda atual

      const section = document.createElement("div");
      section.className = "date-section";
      section.dataset.data = data;

      const compromissos = document.createElement("div");
      compromissos.className = "commitments";

      // Busca os dados do Firebase
      const snapshot = await database.ref("agenda/" + data).once("value");
      let dadosSalvos = snapshot.val() || [];

      while (dadosSalvos.length < 15)
        dadosSalvos.push({ texto: "", hora: "", tachado: false, selecionado: false });

      dadosSalvos.forEach((item) => compromissos.appendChild(criarCampoCompromisso(item)));
      section.appendChild(compromissos);
      agendaEl.appendChild(section);
    }

    /* Salvamento da agenda */
    function salvarAgenda() {
      const data = dataInput.value;
      const section = document.querySelector(".date-section");
      if (!section) return;

      const textos = [];
      section.querySelectorAll(".commitment").forEach((div) => {
        const input = div.querySelector('input[type="text"]');
        const checkbox = div.querySelector('input[type=checkbox]');
        textos.push({
          texto: input.value,
          hora: "", // O campo hora n√£o √© usado, mantive a estrutura
          tachado: input.classList.contains("done"),
          selecionado: checkbox.checked,
        });
      });
      // Salva os dados no Firebase no "caminho" agenda/ANO-MES-DIA
      database.ref("agenda/" + data).set(textos);
    }

    /* Cria um campo de compromisso (l√≥gica interna n√£o muda) */
    function criarCampoCompromisso(item = { texto: "", hora: "", tachado: false, selecionado: false }) {
      const div = document.createElement("div");
      div.className = "commitment";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = item.selecionado;
      checkbox.addEventListener("change", () => {
        div.classList.toggle("checked", checkbox.checked);
        salvarAgenda();
      });
      if (item.selecionado) {
        div.classList.add("checked");
      }

      const input = document.createElement("input");
      input.type = "text";
      input.value = item.texto;
      if (item.tachado) input.classList.add("done");

      input.addEventListener("input", salvarComDelay);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const allInputs = [...document.querySelectorAll(".commitment input[type=text]")];
          const idx = allInputs.indexOf(input);
          const next = allInputs[idx + 1];
          if (next) next.focus();
        }
      });

      const okBtn = document.createElement("button");
      okBtn.textContent = "OK";
      okBtn.onclick = () => {
        input.classList.toggle("done");
        salvarAgenda();
      };

      const delBtn = document.createElement("button");
      delBtn.textContent = "Excluir";
      delBtn.onclick = () => {
        input.value = "";
        input.classList.remove("done");
        salvarAgenda();
      };

      div.appendChild(checkbox);
      div.appendChild(input);
      div.appendChild(okBtn);
      div.appendChild(delBtn);
      return div;
    }

    /* Adiciona um novo campo de compromisso */
    function adicionarCompromisso() {
      const compromissos = document.querySelector(".commitments");
      if (compromissos.children.length < maxCompromissos) {
        compromissos.appendChild(criarCampoCompromisso());
      }
    }

    /* Pesquisa por compromissos no Firebase */
    async function pesquisarCompromisso() {
      const termo = searchEl.value.trim().toLowerCase();
      searchResultsEl.innerHTML = "";
      if (termo.length < 3) return;

      const resultados = [];
      // Pega todos os dados da agenda de uma vez do Firebase
      const snapshot = await database.ref("agenda").once("value");
      const todasAsAgendas = snapshot.val();

      if (todasAsAgendas) {
        for (const data in todasAsAgendas) {
          const dadosDoDia = todasAsAgendas[data] || [];
          dadosDoDia.forEach((item, index) => {
            if (item.texto && item.texto.toLowerCase().includes(termo)) {
              resultados.push({ data, index, item });
            }
          });
        }
      }

      if (resultados.length > 0) {
        resultados.forEach(({ data, index, item }) => {
          const divResultado = document.createElement("div");
          divResultado.textContent = `Dia: ${data} - ${item.texto}`;
          divResultado.onclick = () => {
            dataInput.value = data;
            carregarAgenda().then(() => {
              // Espera carregar a agenda antes de destacar
              const compromisso = agendaEl.querySelectorAll(".commitment")[index];
              if (compromisso) {
                compromisso.scrollIntoView({ behavior: "smooth", block: "center" });
                compromisso.classList.add("destaque");
                setTimeout(() => compromisso.classList.remove("destaque"), 2000);
              }
            });
          };
          searchResultsEl.appendChild(divResultado);
        });
      } else {
        searchResultsEl.textContent = "Nenhum compromisso encontrado.";
      }
    }

    /* Limpa busca */
    function limparBusca() {
      searchEl.value = "";
      searchResultsEl.innerHTML = "";
    }

    /* Fun√ß√µes de Copiar/Colar (l√≥gica interna n√£o muda) */
    function copiarCompromissos() {
      bufferCopiados = [];
      const section = document.querySelector(".date-section");
      if (!section) return;

      const compromissos = section.querySelectorAll(".commitment");
      compromissos.forEach((div) => {
        const input = div.querySelector('input[type="text"]');
        if (!input.classList.contains("done")) {
          bufferCopiados.push(input.value);
          input.classList.add("done");
        }
      });
      salvarAgenda();
    }

    function colarCompromissos() {
      if (!bufferCopiados.length) return;
      const compromissosDiv = document.querySelector(".commitments");
      if (!compromissosDiv) return;

      let idxBuffer = 0;

      function encontrarOuAdicionarCampoVazio() {
        const vazio = [...compromissosDiv.children].find(
          (div) => !div.querySelector("input[type=text]").value
        );
        if (vazio) return vazio;
        if (compromissosDiv.children.length < maxCompromissos) {
          const novo = criarCampoCompromisso();
          compromissosDiv.appendChild(novo);
          return novo;
        }
        return null;
      }

      while (idxBuffer < bufferCopiados.length) {
        const campo = encontrarOuAdicionarCampoVazio();
        if (!campo) break;
        const input = campo.querySelector("input[type=text]");
        const checkbox = campo.querySelector('input[type="checkbox"]');
        input.value = bufferCopiados[idxBuffer++];
        input.classList.remove("done");
        checkbox.checked = false;
        campo.classList.remove("checked");
      }
      salvarAgenda();
    }

    /* Fun√ß√µes de CPF (n√£o mudam) */
    function validarCPF(cpf) {
      if (!cpf || cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
      let soma = 0,
        resto;
      for (let i = 1; i <= 9; i++) soma += parseInt(cpf[i - 1]) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf[9])) return false;
      soma = 0;
      for (let i = 1; i <= 10; i++) soma += parseInt(cpf[i - 1]) * (12 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      return resto === parseInt(cpf[10]);
    }

    document.getElementById("cpf").addEventListener("input", () => {
      const raw = document.getElementById("cpf").value.replace(/\D/g, "");
      const status = document.getElementById("cpfStatus");
      const valido = validarCPF(raw);
      status.textContent = valido ? "CPF v√°lido" : "CPF inv√°lido";
      status.className = valido ? "valid" : "invalid";
    });

    function copiarCPF() {
      let raw = document.getElementById("cpf").value.replace(/\D/g, "");
      if (validarCPF(raw)) {
        let formatado = raw.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        navigator.clipboard.writeText(formatado);
      }
    }

    function limparCPF() {
      document.getElementById("cpf").value = "";
      document.getElementById("cpfStatus").textContent = "";
      document.getElementById("cpfStatus").className = "";
    }

    /* Fun√ß√µes das Notas Fixas com Firebase */
    async function carregarNotasFixas() {
      const snapshot = await database.ref("notasFixas").once("value");
      notasFixasEl.value = snapshot.val() || "";
    }

    notasFixasEl.addEventListener("input", () => {
      database.ref("notasFixas").set(notasFixasEl.value);
    });

    /* Converte para mai√∫sculas */
    document.addEventListener("input", (e) => {
      if (e.target.matches("input[type='text'], textarea")) {
        const pos = e.target.selectionStart;
        e.target.value = e.target.value.toUpperCase();
        e.target.setSelectionRange(pos, pos);
      }
    });
  </script>
</body>
</html>




