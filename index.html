<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda do Fofo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ================================================================== */
        /* ============ IN√çCIO DO NOVO CSS - VISUAL MELHORADO ============ */
        /* ================================================================== */

        /* --- Vari√°veis de Design para f√°cil customiza√ß√£o --- */
        :root {
            --primary-color: #3b82f6; /* Azul moderno */
            --primary-hover: #2563eb;
            --background-color: #f8f9fa; /* Fundo geral suave */
            --surface-color: #ffffff; /* Cor de 'cart√µes' e pain√©is */
            --text-color: #343a40; /* Cor de texto principal */
            --subtle-text-color: #6c757d;/* Cor de texto secund√°rio */
            --border-color: #dee2e6; /* Cor de bordas suaves */
            --danger-color: #dc3545;
            --success-color: #198754;
            --highlight-color: #ffc107;
            --font-family: 'Poppins', sans-serif;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }

        /* --- Reset e Estilos Globais --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 14px; /* AJUSTE: Fonte base diminu√≠da */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Estiliza√ß√£o da Tela de Login --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #login-form {
            background-color: var(--surface-color);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            width: 100%;
            max-width: 380px;
        }
        #login-form h2 {
            margin-bottom: 25px;
            font-weight: 600;
            color: var(--text-color);
        }
        #password-container {
            position: relative;
            margin-bottom: 15px;
        }
        #login-form input[type="password"] {
            padding: 12px 40px 12px 15px;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #login-form input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        #password-container button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--subtle-text-color);
        }
        #login-button, #set-password-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            width: 100%;
            transition: background-color 0.2s;
        }
        #login-button:hover, #set-password-button:hover {
            background-color: var(--primary-hover);
        }
        #error-message {
            color: var(--danger-color);
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }
        #setup-message p {
            color: var(--subtle-text-color);
            margin-bottom: 15px;
        }

        /* --- Layout Principal da Agenda --- */
        .container {
            display: none;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                min-height: 100vh;
            }
        }

        .left-panel, .right-panel {
            padding: 25px; /* AJUSTE: Espa√ßamento diminu√≠do */
        }

        .left-panel {
            flex: 2;
            background-color: var(--surface-color);
            border-right: 1px solid var(--border-color);
        }

        .right-panel {
            flex: 1;
            background-color: var(--background-color);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        /* --- Estilos Gerais para Bot√µes e Inputs --- */
        button {
            font-family: var(--font-family);
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 6px 12px; /* AJUSTE: Espa√ßamento diminu√≠do */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            font-size: 0.85em;
            color: var(--text-color);
        }

        button:hover {
            border-color: var(--primary-color);
            background-color: #f0f6ff;
            color: var(--primary-color);
        }

        button:active {
            transform: translateY(1px);
        }

        /* AJUSTE: Removido width: 100% daqui para permitir campos inline */
        input[type="text"], input[type="date"], input[type="time"], textarea {
            font-family: var(--font-family);
            padding: 8px; /* AJUSTE: Espa√ßamento diminu√≠do */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9em;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* AJUSTE: Regras espec√≠ficas para inputs que devem ocupar a linha toda */
        #login-form input[type="password"], #alarmes input[type="text"], textarea#notasFixas {
            width: 100%;
        }

        /* --- Bot√µes de A√ß√£o Espec√≠ficos --- */
        #novoBtn {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        #novoBtn:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
            color: white;
        }
        #hojeBtn, #prevDayBtn, #nextDayBtn, .commitment button, .right-panel button[title] {
            padding: 6px 10px;
        }

        /* --- Se√ß√£o da Agenda (Painel Esquerdo) --- */
        .calendar-section, .actions, .search-area, .day-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .commitment {
            display: flex;
            align-items: center;
            margin-bottom: 5px; /* AJUSTE: Espa√ßamento diminu√≠do */
            padding: 5px;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            transition: background-color 0.2s, border-color 0.2s;
        }
        
        /* CORRE√á√ÉO: A regra :hover foi movida para DEPOIS de :nth-child para ter prioridade */
        .commitment:nth-child(even) {
            background-color: #fdfdff;
        }
        
        .commitment.checked {
            background-color: #e9f5ff;
            border-color: #a3d1ff;
        }

        .commitment:hover {
            background-color: #e9f5ff; 
        }

        .commitment.checked .done {
            color: #999;
        }

        .commitment input[type="text"] {
            flex: 1;
            border: none;
            background: transparent;
            padding: 6px;
            margin: 0 8px;
            border-radius: 4px;
        }

        .commitment input[type="text"]:focus {
            background: #f0f3f5;
            box-shadow: none;
        }

        .commitment input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .commitment button {
            padding: 4px 8px;
            font-size: 0.75em;
        }
        
        .commitment input[type="checkbox"] + button {
            margin-left: 4px;
        }

        .commitment button:last-of-type {
            border-color: #ffddd9;
            color: var(--danger-color);
        }
        
        .commitment button:last-of-type:hover {
            background-color: #fff4f2;
            border-color: var(--danger-color);
        }

        .done {
            text-decoration: line-through;
            color: var(--subtle-text-color);
            opacity: 0.8;
        }
        
        .destaque {
            background: var(--highlight-color);
            animation: fadeHighlight 2s ease-out;
        }

        @keyframes fadeHighlight {
            from {
                background-color: var(--highlight-color);
            }
            to {
                background-color: transparent;
            }
        }

        /* --- Painel Direito (Widgets) --- */
        .right-panel > div {
            margin-bottom: 10px;
        }
        #cpfStatus.valid {
            color: var(--success-color);
            font-weight: 500;
        }
        #cpfStatus.invalid {
            color: var(--danger-color);
            font-weight: 500;
        }

        /* AJUSTE: Faz o input do CPF e Pesquisa crescerem para preencher o espa√ßo */
        #cpf, #search {
            flex: 1;
            min-width: 100px; /* Garante que n√£o fiquem pequenos demais */
        }
        
        .search-results {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 5px;
            border-radius: var(--border-radius);
            max-height: 150px; /* AJUSTE: Altura diminu√≠da */
            overflow-y: auto;
            font-size: 0.85em;
        }

        .search-results div {
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .search-results div:hover {
            background-color: #e9f5ff;
            color: var(--primary-color);
        }

        #alarmes > div {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 5px;
            align-items: center;
        }

        /* --- Scrollbar Customizada --- */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        /* ================================================================== */
        /* ============= FIM DO NOVO CSS - VISUAL MELHORADO ============= */
        /* ================================================================== */
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
    <div id="login-screen">
        <div id="login-form">
            <h2 id="login-title">Acesso Restrito</h2>
            <div id="password-container">
                <input type="password" id="password-input" placeholder="Digite a senha" onkeypress="handleKeyPress(event)">
                <button id="toggle-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
            </div>
            <p id="error-message">Senha incorreta. Tente novamente.</p>
            <button id="login-button" onclick="checkPassword()">Entrar</button>
            <div id="setup-message" style="display: none; margin-top: 15px;">
                <p>Ainda n√£o h√° senha. Defina uma para continuar.</p>
                <button id="set-password-button" onclick="setPassword()">Definir Senha</button>
            </div>
        </div>
    </div>

    <div class="container" id="main-content">
        <div class="left-panel">
            <h2>Agenda de compromissos</h2>
            <div style="margin-bottom: 15px;">
                <button onclick="window.open('https://luizcezarmelo.github.io/a/despesas.html', '_blank')">Despesas</button>
            </div>
            <div class="calendar-section">
                <input type="date" id="dataSelecionada">
                <button id="hojeBtn" title="Hoje">üìÖ</button>
            </div>
            <div class="day-nav">
                <button id="prevDayBtn" title="Dia anterior">‚óÄ</button>
                <button id="nextDayBtn" title="Pr√≥ximo dia">‚ñ∂</button>
            </div>
            <div class="actions">
                <button id="novoBtn">Novo</button>
                <button id="organizarBtn">Organizar</button>
                <button id="copiarBtn">Copiar</button>
                <button id="colarBtn">Colar</button>
                <button id="exportarBtn">Exportar TXT</button>
            </div>
            <div id="agenda"></div>
        </div>
        <div class="right-panel">
            <h2>Ferramentas</h2>
            <h3>Validador de CPF</h3>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <input type="text" id="cpf" placeholder="Digite o CPF">
                <button onclick="limparCPF()" title="Limpar CPF">‚ùå</button>
            </div>
            <p id="cpfStatus"></p>
            <button onclick="copiarCPF()">Copiar</button>
            
            <h3>üîç Pesquisa</h3>
            <div class="search-area">
                <input type="text" id="search" placeholder="Pesquisar...">
                <button onclick="limparBusca()">‚ùå</button>
            </div>
            <div id="searchResults" class="search-results"></div>
            
            <h3>‚è∞ Alarmes</h3>
            <div id="alarmes" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
                <div>
                    <input type="text" id="alarmMessage1" placeholder="Descri√ß√£o do alarme 1">
                    <input type="time" id="alarmTime1">
                    <button onclick="setAlarm(1)">OK</button>
                    <button onclick="clearAlarm(1)" title="Limpar Alarme 1">‚ùå</button>
                </div>
                <div>
                    <input type="text" id="alarmMessage2" placeholder="Descri√ß√£o do alarme 2">
                    <input type="time" id="alarmTime2">
                    <button onclick="setAlarm(2)">OK</button>
                    <button onclick="clearAlarm(2)" title="Limpar Alarme 2">‚ùå</button>
                </div>
                <div>
                    <input type="text" id="alarmMessage3" placeholder="Descri√ß√£o do alarme 3">
                    <input type="time" id="alarmTime3">
                    <button onclick="setAlarm(3)">OK</button>
                    <button onclick="clearAlarm(3)" title="Limpar Alarme 3">‚ùå</button>
                </div>
            </div>
            
            <h3>üìù Lembretes</h3>
            <textarea id="notasFixas" rows="20" style="width: 100%; resize: vertical;"></textarea>
        </div>
    </div>

    <script>
        // --- L√ìGICA DE LOGIN INSERIDA AQUI ---
        // NENHUMA ALTERA√á√ÉO FEITA NO JAVASCRIPT
        const PASSWORD_NODE = 'appPassword'; // Nome do n√≥ no Firebase para armazenar a senha

        const mainContent = document.getElementById('main-content');
        const loginScreen = document.getElementById('login-screen');
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const setupMessage = document.getElementById('setup-message');
        const loginTitle = document.getElementById('login-title');

        // Inicializa o Firebase (manter a sua configura√ß√£o)
        const firebaseConfig = {
            apiKey: "AIzaSyDQOGFiqafMZh0ha6XW62P1DpIKJE8TBYc",
            authDomain: "agenda-online-7b71c.firebaseapp.com",
            databaseURL: "https://agenda-online-7b71c-default-rtdb.firebaseio.com",
            projectId: "agenda-online-7b71c",
            storageBucket: "agenda-online-7b71c.appspot.com",
            messagingSenderId: "28125733214",
            appId: "1:28125733214:web:162d1cce5d14f55c24afcf"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let correctPassword = null;

        // Fun√ß√£o para verificar a senha no Firebase
        async function loadPassword() {
            const snapshot = await database.ref(PASSWORD_NODE).once('value');
            correctPassword = snapshot.val();
            if (correctPassword) {
                setupMessage.style.display = 'none';
                loginTitle.textContent = 'Acesso Restrito';
            } else {
                setupMessage.style.display = 'block';
                loginTitle.textContent = 'Configurar Senha';
                document.getElementById('login-button').style.display = 'none';
                passwordInput.placeholder = 'Defina uma senha';
            }
            loginScreen.style.display = 'flex';
            passwordInput.focus(); // Foco autom√°tico no campo de senha
        }

        // Fun√ß√£o para definir a senha pela primeira vez
        function setPassword() {
            const newPassword = passwordInput.value;
            if (newPassword && newPassword.trim() !== '') {
                database.ref(PASSWORD_NODE).set(newPassword).then(() => {
                    alert('Senha definida com sucesso!');
                    loadPassword(); // Recarrega para mostrar a tela de login
                    passwordInput.value = '';
                    document.getElementById('login-button').style.display = 'block';
                    passwordInput.placeholder = 'Digite a senha';
                }).catch(error => {
                    console.error("Erro ao salvar a senha:", error);
                    alert("Ocorreu um erro. Tente novamente.");
                });
            } else {
                alert('A senha n√£o pode ser vazia.');
            }
        }
        
        // Fun√ß√£o para verificar a senha digitada
        function checkPassword() {
            const enteredPassword = passwordInput.value;
            if (enteredPassword === correctPassword) {
                showMainContent();
            } else {
                errorMessage.style.display = 'block';
                passwordInput.value = ''; // Limpa o campo da senha
            }
        }

        // Fun√ß√£o para mostrar o conte√∫do principal
        function showMainContent() {
            loginScreen.style.display = 'none';
            mainContent.style.display = 'flex';
            carregarAgenda();
            carregarNotasFixas();
            loadAlarms();
        }

        // Fun√ß√£o para alternar a visibilidade da senha
        function togglePasswordVisibility() {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                togglePasswordBtn.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                togglePasswordBtn.textContent = 'üëÅÔ∏è';
            }
        }
        
        // Fun√ß√£o para permitir o login com a tecla Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                if (correctPassword) {
                    checkPassword();
                } else {
                    setPassword();
                }
            }
        }

        // Inicia o processo de login
        window.addEventListener('load', () => {
            loadPassword();
        });
        
        // --- FIM DA L√ìGICA DE LOGIN ---

        // Elementos principais e vari√°veis globais
        const agendaEl = document.getElementById('agenda');
        const searchEl = document.getElementById('search');
        const searchResultsEl = document.getElementById('searchResults');
        const dataInput = document.getElementById('dataSelecionada');
        const novoBtn = document.getElementById('novoBtn');
        const organizarBtn = document.getElementById('organizarBtn');
        const copiarBtn = document.getElementById('copiarBtn');
        const colarBtn = document.getElementById('colarBtn');
        const exportarBtn = document.getElementById('exportarBtn');
        const hojeBtn = document.getElementById('hojeBtn');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');
        const notasFixasEl = document.getElementById('notasFixas');
        const maxCompromissos = 20;
        let bufferCopiados = [];

        /* Configura√ß√£o inicial */
        dataInput.value = new Date().toISOString().split('T')[0];

        /* Listeners de interface */
        dataInput.addEventListener('change', carregarAgenda);
        novoBtn.addEventListener('click', adicionarCompromisso);
        organizarBtn.addEventListener('click', organizarAgenda);
        copiarBtn.addEventListener('click', copiarCompromissos);
        colarBtn.addEventListener('click', colarCompromissos);
        exportarBtn.addEventListener('click', () => exportarParaTXT(dataInput.value));
        hojeBtn.addEventListener('click', () => {
            const hoje = new Date().toISOString().split('T')[0];
            dataInput.value = hoje;
            carregarAgenda();
        });
        prevDayBtn.addEventListener('click', () => {
            const d = new Date(dataInput.value);
            d.setDate(d.getDate() - 1);
            dataInput.value = d.toISOString().split('T')[0];
            carregarAgenda();
        });
        nextDayBtn.addEventListener('click', () => {
            const d = new Date(dataInput.value);
            d.setDate(d.getDate() + 1);
            dataInput.value = d.toISOString().split('T')[0];
            carregarAgenda();
        });
        searchEl.addEventListener('input', pesquisarCompromisso);

        /* Salvamento com delay */
        let debounceTimer;
        function salvarComDelay() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => salvarAgenda(), 1000);
        }

        /* Carregar agenda do dia selecionado */
        async function carregarAgenda() {
            const data = dataInput.value;
            agendaEl.innerHTML = ''; // Limpa a agenda atual
            const section = document.createElement('div');
            section.className = 'date-section';
            section.dataset.data = data;
            const compromissos = document.createElement('div');
            compromissos.className = 'commitments';
            // Busca os dados do Firebase
            const snapshot = await database.ref('agenda/' + data).once('value');
            let dadosSalvos = snapshot.val() || [];
            while (dadosSalvos.length < 15) dadosSalvos.push({ texto: '', hora: '', tachado: false, selecionado: false });
            dadosSalvos.forEach(item => compromissos.appendChild(criarCampoCompromisso(item)));
            section.appendChild(compromissos);
            agendaEl.appendChild(section);
        }

        /* Salvamento da agenda */
        function salvarAgenda() {
            const data = dataInput.value;
            const section = document.querySelector('.date-section');
            if (!section) return;
            const textos = [];
            section.querySelectorAll('.commitment').forEach(div => {
                const input = div.querySelector('input[type=text]');
                const checkbox = div.querySelector('input[type=checkbox]');
                textos.push({
                    texto: input.value,
                    hora: '',
                    tachado: input.classList.contains('done'),
                    selecionado: checkbox.checked
                });
            });
            database.ref('agenda/' + data).set(textos);
        }

        /* Cria um campo de compromisso */
        function criarCampoCompromisso(item = { texto: '', hora: '', tachado: false, selecionado: false }) {
            const div = document.createElement('div');
            div.className = 'commitment';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = item.selecionado;
            checkbox.addEventListener('change', () => {
                div.classList.toggle('checked', checkbox.checked);
                salvarAgenda();
            });
            if (item.selecionado) {
                div.classList.add('checked');
            }

            const input = document.createElement('input');
            input.type = 'text';
            input.value = item.texto;
            if (item.tachado) input.classList.add('done');
            input.addEventListener('input', salvarComDelay);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const allInputs = [...document.querySelectorAll('.commitment input[type=text]')];
                    const idx = allInputs.indexOf(input);
                    const next = allInputs[idx + 1];
                    if (next) next.focus();
                }
            });

            const okBtn = document.createElement('button');
            okBtn.textContent = 'OK';
            okBtn.onclick = () => {
                input.classList.toggle('done');
                salvarAgenda();
            };

            const delBtn = document.createElement('button');
            delBtn.textContent = 'Excluir';
            delBtn.onclick = () => {
                input.value = '';
                input.classList.remove('done');
                salvarAgenda();
            };

            div.appendChild(okBtn);
            div.appendChild(input);
            div.appendChild(checkbox);
            div.appendChild(delBtn);
            
            return div;
        }

        /* Adiciona um novo campo de compromisso */
        function adicionarCompromisso() {
            const compromissos = document.querySelector('.commitments');
            if (compromissos.children.length < maxCompromissos) {
                compromissos.appendChild(criarCampoCompromisso());
            }
        }
        
        function organizarAgenda() {
            const compromissosDiv = document.querySelector('.commitments');
            if (!compromissosDiv) return;

            // 1. Coletar todos os dados dos campos que est√£o preenchidos
            const dadosPreenchidos = [];
            const todosOsCampos = compromissosDiv.querySelectorAll('.commitment');
            todosOsCampos.forEach(div => {
                const input = div.querySelector('input[type="text"]');
                if (input.value.trim() !== '') {
                    const checkbox = div.querySelector('input[type="checkbox"]');
                    dadosPreenchidos.push({
                        texto: input.value,
                        tachado: input.classList.contains('done'),
                        selecionado: checkbox.checked
                    });
                }
            });

            // 2. Reescrever os dados nos campos desde o in√≠cio
            todosOsCampos.forEach((div, index) => {
                const input = div.querySelector('input[type="text"]');
                const checkbox = div.querySelector('input[type="checkbox"]');
                if (index < dadosPreenchidos.length) {
                    // Preenche com os dados coletados
                    const dados = dadosPreenchidos[index];
                    input.value = dados.texto;
                    checkbox.checked = dados.selecionado;
                    // Ajusta as classes CSS (para visual)
                    input.classList.toggle('done', dados.tachado);
                    div.classList.toggle('checked', dados.selecionado);
                } else {
                    // Limpa os campos excedentes
                    input.value = '';
                    checkbox.checked = false;
                    input.classList.remove('done');
                    div.classList.remove('checked');
                }
            });
            
            // 3. Salvar o novo estado no Firebase
            salvarAgenda();
        }

        /* Pesquisa por compromissos no Firebase */
        async function pesquisarCompromisso() {
            const termo = searchEl.value.trim().toLowerCase();
            searchResultsEl.innerHTML = '';
            if (termo.length < 3) return;

            const resultados = [];
            const snapshot = await database.ref('agenda').once('value');
            const todasAsAgendas = snapshot.val();

            if (todasAsAgendas) {
                for (const data in todasAsAgendas) {
                    const dadosDoDia = todasAsAgendas[data] || [];
                    dadosDoDia.forEach((item, index) => {
                        if (item.texto && item.texto.toLowerCase().includes(termo)) {
                            resultados.push({ data, index, item });
                        }
                    });
                }
            }

            if (resultados.length > 0) {
                resultados.forEach(({ data, index, item }) => {
                    const divResultado = document.createElement('div');
                    divResultado.textContent = `Dia: ${data} - ${item.texto}`;
                    divResultado.onclick = () => {
                        dataInput.value = data;
                        carregarAgenda().then(() => {
                            const compromisso = agendaEl.querySelectorAll('.commitment')[index];
                            if (compromisso) {
                                compromisso.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                compromisso.classList.add('destaque');
                                setTimeout(() => compromisso.classList.remove('destaque'), 2000);
                            }
                        });
                    };
                    searchResultsEl.appendChild(divResultado);
                });
            } else {
                searchResultsEl.textContent = 'Nenhum compromisso encontrado.';
            }
        }

        /* Limpa busca */
        function limparBusca() {
            searchEl.value = '';
            searchResultsEl.innerHTML = '';
        }

        /* Exporta para TXT */
        async function exportarParaTXT(data) {
            const snapshot = await database.ref('agenda/' + data).once('value');
            const dados = snapshot.val() || [];
            let conteudo = 'Agenda de ' + data + '\n\n';
            dados.forEach((item, i) => {
                if (item.texto) {
                    conteudo += (i + 1) + '. ' + item.texto + (item.tachado ? ' (Conclu√≠do)' : '') + '\n';
                }
            });
            const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `agenda_${data}.txt`;
            a.click();
        }

        /* Fun√ß√µes de Copiar/Colar */
        function copiarCompromissos() {
            bufferCopiados = [];
            const section = document.querySelector('.date-section');
            if (!section) return;
            const compromissos = section.querySelectorAll('.commitment');
            compromissos.forEach(div => {
                const input = div.querySelector('input[type="text"]');
                if (!input.classList.contains('done')) {
                    bufferCopiados.push(input.value);
                    input.classList.add('done');
                }
            });
            salvarAgenda();
        }

        function colarCompromissos() {
            if (!bufferCopiados.length) return;
            const compromissosDiv = document.querySelector('.commitments');
            if (!compromissosDiv) return;

            let idxBuffer = 0;
            function encontrarOuAdicionarCampoVazio() {
                const vazio = [...compromissosDiv.children].find(div => !div.querySelector('input[type=text]').value);
                if (vazio) return vazio;
                if (compromissosDiv.children.length < maxCompromissos) {
                    const novo = criarCampoCompromisso();
                    compromissosDiv.appendChild(novo);
                    return novo;
                }
                return null;
            }

            while (idxBuffer < bufferCopiados.length) {
                const campo = encontrarOuAdicionarCampoVazio();
                if (!campo) break;
                const input = campo.querySelector('input[type=text]');
                const checkbox = campo.querySelector('input[type="checkbox"]');
                input.value = bufferCopiados[idxBuffer++];
                input.classList.remove('done');
                checkbox.checked = false;
                campo.classList.remove('checked');
            }
            salvarAgenda();
        }

        /* Fun√ß√µes de CPF */
        function validarCPF(cpf) {
            if (!cpf || cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let soma = 0, resto;
            for (let i = 1; i <= 9; i++) soma += parseInt(cpf[i - 1]) * (11 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf[9])) return false;
            soma = 0;
            for (let i = 1; i <= 10; i++) soma += parseInt(cpf[i - 1]) * (12 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            return resto === parseInt(cpf[10]);
        }
        document.getElementById('cpf').addEventListener('input', () => {
            const raw = document.getElementById('cpf').value.replace(/\D/g, '');
            const status = document.getElementById('cpfStatus');
            const valido = validarCPF(raw);
            status.textContent = valido ? 'CPF v√°lido' : 'CPF inv√°lido';
            status.className = valido ? 'valid' : 'invalid';
        });
        function copiarCPF() {
            let raw = document.getElementById('cpf').value.replace(/\D/g, '');
            if (validarCPF(raw)) {
                let formatado = raw.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                navigator.clipboard.writeText(formatado);
            }
        }
        function limparCPF() {
            document.getElementById('cpf').value = '';
            document.getElementById('cpfStatus').textContent = '';
            document.getElementById('cpfStatus').className = '';
        }

        /* Fun√ß√µes das Notas Fixas com Firebase */
        async function carregarNotasFixas() {
            const snapshot = await database.ref('notasFixas').once('value');
            notasFixasEl.value = snapshot.val() || '';
        }
        notasFixasEl.addEventListener('input', () => {
            database.ref('notasFixas').set(notasFixasEl.value);
        });

        /* Converte para mai√∫sculas */
        document.addEventListener('input', (e) => {
            if (e.target.matches('input[type="text"], textarea')) {
                const pos = e.target.selectionStart;
                e.target.value = e.target.value.toUpperCase();
                e.target.setSelectionRange(pos, pos);
            }
        });

        /* ================= ALARMES PERSISTENTES ================= */
        let alarmTimeouts = {};
        let alarmBlinkInterval = null;
        let originalTitle = document.title;
        let triggeredAlarms = new Set();

        async function loadAlarms() {
            const snapshot = await database.ref('alarms').once('value');
            const savedAlarms = snapshot.val();
            if (savedAlarms) {
                for (const id in savedAlarms) {
                    const alarmData = savedAlarms[id];
                    if (alarmData && alarmData.time && alarmData.message) {
                        document.getElementById(`alarmMessage${id}`).value = alarmData.message;
                        document.getElementById(`alarmTime${id}`).value = alarmData.time;
                        setAlarm(id, true);
                    }
                }
            }
        }
        
        function setAlarm(id, silent = false) {
            const msgEl = document.getElementById(`alarmMessage${id}`);
            const timeEl = document.getElementById(`alarmTime${id}`);
            const msg = msgEl.value.trim();
            const time = timeEl.value;

            if (!msg || !time) {
                if (!silent) alert("Preencha a frase e o hor√°rio do alarme " + id);
                return;
            }

            database.ref(`alarms/${id}`).set({ message: msg, time: time });

            if (alarmTimeouts[id]) {
                clearTimeout(alarmTimeouts[id]);
            }
            const [h, m] = time.split(':').map(Number);
            const now = new Date();
            const alarm = new Date(now);
            alarm.setHours(h, m, 0, 0);

            if (alarm < now) {
                alarm.setDate(alarm.getDate() + 1);
            }

            const diff = alarm.getTime() - now.getTime();
            alarmTimeouts[id] = setTimeout(() => triggerAlarm(msg, id), diff);
        }
        
        function clearAlarm(id) {
            if (alarmTimeouts[id]) {
                clearTimeout(alarmTimeouts[id]);
                delete alarmTimeouts[id];
            }
            document.getElementById(`alarmMessage${id}`).value = '';
            document.getElementById(`alarmTime${id}`).value = '';
            database.ref(`alarms/${id}`).remove();
        }

        function triggerAlarm(message, id) {
            if (triggeredAlarms.has(id)) return;
            triggeredAlarms.add(id);

            alert("‚è∞ ALARME " + id + ": " + message);

            if (!alarmBlinkInterval) {
                let visible = true;
                alarmBlinkInterval = setInterval(() => {
                    document.title = visible ? "‚ö†Ô∏è ALARME ‚ö†Ô∏è" : originalTitle;
                    visible = !visible;
                }, 800);
                window.addEventListener('focus', stopAlarmBlink, { once: true });
                window.addEventListener('click', stopAlarmBlink, { once: true });
            }
            database.ref(`alarms/${id}`).remove();
        }

        function stopAlarmBlink() {
            if (alarmBlinkInterval) {
                clearInterval(alarmBlinkInterval);
                alarmBlinkInterval = null;
            }
            document.title = originalTitle;
            triggeredAlarms.clear();
            window.removeEventListener('focus', stopAlarmBlink);
            window.removeEventListener('click', stopAlarmBlink);
        }
        /* ======================================================== */
    </script>
</body>
</html>
