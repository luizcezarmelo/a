<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda do Fofo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ================================================================== */
        /* ============ IN√çCIO DO NOVO CSS - VISUAL MELHORADO ============ */
        /* ================================================================== */
        /* --- Vari√°veis de Design para f√°cil customiza√ß√£o --- */
        :root {
            --primary-color: #3b82f6; /* Azul moderno */
            --primary-hover: #2563eb;
            --background-color: #f8f9fa; /* Fundo geral suave */
            --surface-color: #ffffff; /* Cor de 'cart√µes' e pain√©is */
            --text-color: #343a40; /* Cor de texto principal */
            --subtle-text-color: #6c757d;/* Cor de texto secund√°rio */
            --border-color: #dee2e6; /* Cor de bordas suaves */
            --danger-color: #dc3545;
            --success-color: #198754;
            --highlight-color: #ffc107;
            --font-family: 'Poppins', sans-serif;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }

        /* --- Reset e Estilos Globais --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 14px; /* AJUSTE: Fonte base diminu√≠da */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Estiliza√ß√£o da Tela de Login --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #login-form {
            background-color: var(--surface-color);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            width: 100%;
            max-width: 380px;
        }

        #login-form h2 {
            margin-bottom: 25px;
            font-weight: 600;
            color: var(--text-color);
        }

        #password-container {
            position: relative;
            margin-bottom: 15px;
        }

        #login-form input[type="password"] {
            padding: 12px 40px 12px 15px;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #login-form input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        #password-container button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--subtle-text-color);
        }

        #login-button,
        #set-password-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            width: 100%;
            transition: background-color 0.2s;
        }

        #login-button:hover,
        #set-password-button:hover {
            background-color: var(--primary-hover);
        }

        #error-message {
            color: var(--danger-color);
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }

        #setup-message p {
            color: var(--subtle-text-color);
            margin-bottom: 15px;
        }

        /* --- Layout Principal da Agenda --- */
        .container {
            display: none;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                min-height: 100vh;
            }
        }

        .left-panel,
        .right-panel {
            padding: 25px; /* AJUSTE: Espa√ßamento diminu√≠do */
        }

        .left-panel {
            flex: 2;
            background-color: var(--surface-color);
            border-right: 1px solid var(--border-color);
        }

        .right-panel {
            flex: 1;
            background-color: var(--background-color);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        /* --- Estilos Gerais para Bot√µes e Inputs --- */
        button {
            font-family: var(--font-family);
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 6px 12px; /* AJUSTE: Espa√ßamento diminu√≠do */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            font-size: 0.85em;
            color: var(--text-color);
        }

        button:hover {
            border-color: var(--primary-color);
            background-color: #f0f6ff;
            color: var(--primary-color);
        }

        button:active {
            transform: translateY(1px);
        }

        /* AJUSTE: Removido width: 100% daqui para permitir campos inline */
        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea {
            font-family: var(--font-family);
            padding: 8px; /* AJUSTE: Espa√ßamento diminu√≠do */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9em;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* AJUSTE: Regras espec√≠ficas para inputs que devem ocupar a linha toda */
        #login-form input[type="password"],
        #alarmes input[type="text"],
        textarea#notasFixas {
            width: 100%;
        }

        /* --- Bot√µes de A√ß√£o Espec√≠ficos --- */
        #novoBtn {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        #novoBtn:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
            color: white;
        }

        #hojeBtn,
        #prevDayBtn,
        #nextDayBtn,
        .commitment button,
        .right-panel button[title] {
            padding: 6px 10px;
        }

        /* --- Se√ß√£o da Agenda (Painel Esquerdo) --- */
        .calendar-section,
        .actions,
        .search-area,
        .day-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .commitment {
            display: flex;
            align-items: center;
            margin-bottom: 5px; /* AJUSTE: Espa√ßamento diminu√≠do */
            padding: 5px;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            transition: background-color 0.2s, border-color 0.2s;
        }

        /* CORRE√á√ÉO: A regra :hover foi movida para DEPOIS de :nth-child para ter prioridade */
        .commitment:nth-child(even) {
            background-color: #fdfdff;
        }

        .commitment.checked {
            background-color: #e9f5ff;
            border-color: #a3d1ff;
        }

        .commitment:hover {
            background-color: #e9f5ff;
        }

        .commitment.checked .done {
            color: #999;
        }

        .commitment input[type="text"] {
            flex: 1;
            border: none;
            background: transparent;
            padding: 6px;
            margin: 0 8px;
            border-radius: 4px;
        }

        .commitment input[type="text"]:focus {
            background: #f0f3f5;
            box-shadow: none;
        }

        .commitment input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .commitment button {
            padding: 4px 8px;
            font-size: 0.75em;
        }

        .commitment input[type="checkbox"] + button {
            margin-left: 4px;
        }

        .commitment button:last-of-type {
            border-color: #ffddd9;
            color: var(--danger-color);
        }

        .commitment button:last-of-type:hover {
            background-color: #fff4f2;
            border-color: var(--danger-color);
        }

        .done {
            text-decoration: line-through;
            color: var(--subtle-text-color);
            opacity: 0.8;
        }
        
        /* NOVO: Estilo para item recorrente */
        .commitment.recorrente input[type="text"] {
            font-style: italic;
            color: #555;
        }
        .commitment.recorrente button:first-of-type {
            border-color: var(--primary-color);
        }

        .destaque {
            background: var(--highlight-color);
            animation: fadeHighlight 2s ease-out;
        }

        @keyframes fadeHighlight {
            from {
                background-color: var(--highlight-color);
            }
            to {
                background-color: transparent;
            }
        }

        /* --- Painel Direito (Widgets) --- */
        .right-panel > div {
            margin-bottom: 10px;
        }

        /* (Estilos de CPF removidos para economizar espa√ßo, mas ainda est√£o no seu c√≥digo) */
        #cpfStatus.valid {
            color: var(--success-color);
            font-weight: 500;
        }

        #cpfStatus.invalid {
            color: var(--danger-color);
            font-weight: 500;
        }

        /* AJUSTE: Faz o input do CPF e Pesquisa crescerem para preencher o espa√ßo */
        #cpf,
        #search {
            flex: 1;
            min-width: 100px; /* Garante que n√£o fiquem pequenos demais */
        }

        .search-results {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 5px;
            border-radius: var(--border-radius);
            max-height: 150px; /* AJUSTE: Altura diminu√≠da */
            overflow-y: auto;
            font-size: 0.85em;
        }

        .search-results div {
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .search-results div:hover {
            background-color: #e9f5ff;
            color: var(--primary-color);
        }

        #alarmes > div {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 5px;
            align-items: center;
        }

        /* --- Scrollbar Customizada --- */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* ================================================================== */
        /* ============= FIM DO NOVO CSS - VISUAL MELHORADO ============= */
        /* ================================================================== */

        /* --- Estilos dos Modais (NOVO) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 450px;
        }

        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .modal-content input[type="text"] {
            width: 100%;
        }

        .modal-content #frequenciaOpcoes label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .modal-content #frequenciaOpcoes input[type="radio"] {
             margin-right: 8px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            padding: 8px 15px;
        }

        .modal-actions button#salvarRecorrenteBtn {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .modal-actions button#salvarRecorrenteBtn:hover {
            background-color: var(--primary-hover);
        }

        .modal-actions button[id^="excluir"] {
            width: 100%;
            background-color: var(--danger-color);
            color: white;
            border: none;
        }

        .modal-actions button[id^="excluir"]:hover {
            background-color: #b02a37;
        }
         .modal-actions button#cancelarExcluirBtn {
            background-color: #6c757d;
         }
         .modal-actions button#cancelarExcluirBtn:hover {
            background-color: #5a6268;
         }

    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
    <div id="login-screen">
        <div id="login-form">
            <h2 id="login-title">Acesso Restrito</h2>
            <div id="password-container">
                <input type="password" id="password-input" placeholder="Digite a senha" onkeypress="handleKeyPress(event)">
                <button id="toggle-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
            </div>
            <p id="error-message">Senha incorreta. Tente novamente.</p>
            <button id="login-button" onclick="checkPassword()">Entrar</button>
            <div id="setup-message" style="display: none; margin-top: 15px;">
                <p>Ainda n√£o h√° senha. Defina uma para continuar.</p>
                <button id="set-password-button" onclick="setPassword()">Definir Senha</button>
            </div>
        </div>
    </div>

    <div class="container" id="main-content">
        <div class="left-panel">
            <h2>Agenda de compromissos</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="window.open('https://luizcezarmelo.github.io/a/contas.html', '_blank')">Despesas</button>
                <button onclick="window.open('https://luizcezarmelo.github.io/a/Tuto.html', '_blank')">Windows</button>
                <button onclick="window.open('https://luizcezarmelo.github.io/a/gasosa.html', '_blank')">Gasolina</button>
            </div>
            <div class="calendar-section">
                <input type="date" id="dataSelecionada">
                <button id="hojeBtn" title="Hoje">üìÖ</button>
            </div>
            <div class="day-nav">
                <button id="prevDayBtn" title="Dia anterior">‚óÄ</button>
                <button id="nextDayBtn" title="Pr√≥ximo dia">‚ñ∂</button>
            </div>
            <div class="actions">
                <button id="novoBtn">Novo</button>
                <button id="organizarBtn">Organizar</button>
                <button id="copiarBtn">Copiar</button>
                <button id="colarBtn">Colar</button>
                <button id="exportarBtn">Exportar TXT</button>
                <button id="recorrenteBtn" title="Novo Recorrente">üîÑ</button>
            </div>
            <div id="agenda"></div>
        </div>

        <div class="right-panel">
            <h2>Ferramentas</h2>
            <h3>üîç Pesquisa</h3>
            <div class="search-area">
                <input type="text" id="search" placeholder="Pesquisar...">
                <button onclick="limparBusca()">‚ùå</button>
            </div>
            <div id="searchResults" class="search-results"></div>

            <h3>‚è∞ Alarmes</h3>
            <div id="alarm-feedback" style="font-size: 0.9em; color: var(--success-color); margin-bottom: 10px; text-align: center; font-weight: 500; min-height: 1.2em;"></div>
            <div id="alarmes" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
                <div>
                    <input type="text" id="alarmMessage1" placeholder="Descri√ß√£o do alarme 1">
                    <input type="time" id="alarmTime1">
                    <button onclick="setAlarm(1)">OK</button>
                    <button onclick="clearAlarm(1)" title="Limpar Alarme 1">‚ùå</button>
                </div>
                <div>
                    <input type="text" id="alarmMessage2" placeholder="Descri√ß√£o do alarme 2">
                    <input type="time" id="alarmTime2">
                    <button onclick="setAlarm(2)">OK</button>
                    <button onclick="clearAlarm(2)" title="Limpar Alarme 2">‚ùå</button>
                </div>
                <div>
                    <input type="text" id="alarmMessage3" placeholder="Descri√ß√£o do alarme 3">
                    <input type="time" id="alarmTime3">
                    <button onclick="setAlarm(3)">OK</button>
                    <button onclick="clearAlarm(3)" title="Limpar Alarme 3">‚ùå</button>
                </div>
            </div>

            <h3>üìù Lembretes</h3>
            <textarea id="notasFixas" rows="20" style="width: 100%; resize: vertical;"></textarea>
        </div>
    </div>

    <div id="modalRecorrente" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Novo Compromisso Recorrente</h3>
            <p>Este compromisso ser√° repetido a partir do dia <strong>selecionado na agenda</strong>.</p>
            <input type="text" id="recorrenteTexto" placeholder="Descri√ß√£o do compromisso..." style="width: 100%; margin-top: 10px; margin-bottom: 15px;">
            <div id="frequenciaOpcoes" style="text-align: left; margin-bottom: 20px;">
                <label><input type="radio" name="frequencia" value="diario" checked> Di√°rio</label>
                <label><input type="radio" name="frequencia" value="semanal"> Semanal (mesmo dia da semana)</label>
                <label><input type="radio" name="frequencia" value="mensal"> Mensal (mesmo dia do m√™s)</label>
                <label><input type="radio" name="frequencia" value="anual"> Anual (mesma data)</label>
            </div>
            <div class="modal-actions">
                <button id="salvarRecorrenteBtn">Salvar</button>
                <button id="cancelarRecorrenteBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalExcluirRecorrente" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Excluir Compromisso Recorrente</h3>
            <p id="excluirRecorrenteTexto" style="margin-bottom: 15px;">Como deseja excluir este compromisso?</p>
            <div class="modal-actions" style="flex-direction: column; gap: 10px;">
                <button id="excluirUmBtn">Excluir somente esta ocorr√™ncia</button>
                <button id="excluirFuturosBtn">Excluir esta e todas as futuras</button>
                <button id="cancelarExcluirBtn" style="margin-top: 10px;">Cancelar</button>
            </div>
        </div>
    </div>


    <script>
        // --- L√ìGICA DE LOGIN INSERIDA AQUI ---
        // NENHUMA ALTERA√á√ÉO FEITA NO JAVASCRIPT
        const PASSWORD_NODE = 'appPassword'; // Nome do n√≥ no Firebase para armazenar a senha
        const mainContent = document.getElementById('main-content');
        const loginScreen = document.getElementById('login-screen');
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const setupMessage = document.getElementById('setup-message');
        const loginTitle = document.getElementById('login-title');

        // Inicializa o Firebase (manter a sua configura√ß√£o)
        const firebaseConfig = {
            apiKey: "AIzaSyDQOGFiqafMZh0ha6XW62P1DpIKJE8TBYc",
            authDomain: "agenda-online-7b71c.firebaseapp.com",
            databaseURL: "https://agenda-online-7b71c-default-rtdb.firebaseio.com",
            projectId: "agenda-online-7b71c",
            storageBucket: "agenda-online-7b71c.appspot.com",
            messagingSenderId: "28125733214",
            appId: "1:28125733214:web:162d1cce5d14f55c24afcf"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let correctPassword = null;

        // Fun√ß√£o para verificar a senha no Firebase
        async function loadPassword() {
            const snapshot = await database.ref(PASSWORD_NODE).once('value');
            correctPassword = snapshot.val();
            if (correctPassword) {
                setupMessage.style.display = 'none';
                loginTitle.textContent = 'Acesso Restrito';
            } else {
                setupMessage.style.display = 'block';
                loginTitle.textContent = 'Configurar Senha';
                document.getElementById('login-button').style.display = 'none';
                passwordInput.placeholder = 'Defina uma senha';
            }
            loginScreen.style.display = 'flex';
            passwordInput.focus(); // Foco autom√°tico no campo de senha
        }

        // Fun√ß√£o para definir a senha pela primeira vez
        function setPassword() {
            const newPassword = passwordInput.value;
            if (newPassword && newPassword.trim() !== '') {
                database.ref(PASSWORD_NODE).set(newPassword).then(() => {
                    alert('Senha definida com sucesso!');
                    loadPassword(); // Recarrega para mostrar a tela de login
                    passwordInput.value = '';
                    document.getElementById('login-button').style.display = 'block';
                    passwordInput.placeholder = 'Digite a senha';
                }).catch(error => {
                    console.error("Erro ao salvar a senha:", error);
                    alert("Ocorreu um erro. Tente novamente.");
                });
            } else {
                alert('A senha n√£o pode ser vazia.');
            }
        }

        // Fun√ß√£o para verificar a senha digitada
        function checkPassword() {
            const enteredPassword = passwordInput.value;
            if (enteredPassword === correctPassword) {
                showMainContent();
            } else {
                errorMessage.style.display = 'block';
                passwordInput.value = ''; // Limpa o campo da senha
            }
        }

        // Fun√ß√£o para mostrar o conte√∫do principal
        function showMainContent() {
            loginScreen.style.display = 'none';
            mainContent.style.display = 'flex';
            carregarAgenda();
            carregarNotasFixas();
            loadAlarms();
        }

        // Fun√ß√£o para alternar a visibilidade da senha
        function togglePasswordVisibility() {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                togglePasswordBtn.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                togglePasswordBtn.textContent = 'üëÅÔ∏è';
            }
        }

        // Fun√ß√£o para permitir o login com a tecla Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                if (correctPassword) {
                    checkPassword();
                } else {
                    setPassword();
                }
            }
        }

        // Inicia o processo de login
        window.addEventListener('load', () => {
            loadPassword();
        });
        // --- FIM DA L√ìGICA DE LOGIN ---

        // Elementos principais e vari√°veis globais
        const agendaEl = document.getElementById('agenda');
        const searchEl = document.getElementById('search');
        const searchResultsEl = document.getElementById('searchResults');
        const dataInput = document.getElementById('dataSelecionada');
        const novoBtn = document.getElementById('novoBtn');
        const organizarBtn = document.getElementById('organizarBtn');
        const copiarBtn = document.getElementById('copiarBtn');
        const colarBtn = document.getElementById('colarBtn');
        const exportarBtn = document.getElementById('exportarBtn');
        const hojeBtn = document.getElementById('hojeBtn');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');
        const notasFixasEl = document.getElementById('notasFixas');

        // NOVO: Bot√£o recorrente
        const recorrenteBtn = document.getElementById('recorrenteBtn');

        const maxCompromissos = 20;
        let bufferCopiados = [];

        /* Configura√ß√£o inicial */
        dataInput.value = new Date().toISOString().split('T')[0];

        /* Listeners de interface */
        dataInput.addEventListener('change', carregarAgenda);
        novoBtn.addEventListener('click', adicionarCompromisso);
        organizarBtn.addEventListener('click', organizarAgenda);
        copiarBtn.addEventListener('click', copiarCompromissos);
        colarBtn.addEventListener('click', colarCompromissos);
        exportarBtn.addEventListener('click', () => exportarParaTXT(dataInput.value));
        
        // NOVO: Listener do bot√£o recorrente
        recorrenteBtn.addEventListener('click', () => {
             document.getElementById('recorrenteTexto').value = ''; // Limpa o campo
             document.getElementById('modalRecorrente').style.display = 'flex';
             document.getElementById('recorrenteTexto').focus();
        });

        hojeBtn.addEventListener('click', () => {
            const hoje = new Date().toISOString().split('T')[0];
            dataInput.value = hoje;
            carregarAgenda();
        });
        prevDayBtn.addEventListener('click', () => {
            const d = new Date(dataInput.value + "T12:00:00"); // Adiciona hora para evitar problemas de fuso
            d.setDate(d.getDate() - 1);
            dataInput.value = d.toISOString().split('T')[0];
            carregarAgenda();
        });
        nextDayBtn.addEventListener('click', () => {
            const d = new Date(dataInput.value + "T12:00:00"); // Adiciona hora para evitar problemas de fuso
            d.setDate(d.getDate() + 1);
            dataInput.value = d.toISOString().split('T')[0];
            carregarAgenda();
        });
        searchEl.addEventListener('input', pesquisarCompromisso);

        /* Salvamento com delay */
        let debounceTimer;
        function salvarComDelay() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => salvarAgenda(), 1000);
        }

        /* --- FUN√á√ÉO UTILIT√ÅRIA PARA MAI√öSCULAS (NOVA) --- */
        function toUpperOnInput(e) {
            if (e.target.matches('input[type="text"], textarea')) {
                const pos = e.target.selectionStart;
                e.target.value = e.target.value.toUpperCase();
                // Garante que o cursor volte para onde estava
                e.target.setSelectionRange(pos, pos);
            }
        }
        /* ------------------------------------------------- */

        /**
         * ==================================================================
         * IN√çCIO DAS FUN√á√ïES PRINCIPAIS MODIFICADAS (RECORR√äNCIA)
         * ==================================================================
         */

        /* Carregar agenda do dia selecionado (VERS√ÉO MODIFICADA) */
        async function carregarAgenda() {
            const data = dataInput.value;
            const diaSelecionado = new Date(data + 'T12:00:00'); // Usar T12 para evitar problemas de fuso
            
            agendaEl.innerHTML = ''; // Limpa a agenda atual

            // 1. Cria a estrutura da agenda
            const section = document.createElement('div');
            section.className = 'date-section';
            section.dataset.data = data;
            const compromissos = document.createElement('div');
            compromissos.className = 'commitments';

            // 2. Busca os dados NORMAIS do dia
            const snapshot = await database.ref('agenda/' + data).once('value');
            let dadosSalvos = snapshot.val() || [];

            // 3. Busca as REGRAS de recorr√™ncia
            const recorrenciasSnap = await database.ref('recorrencias').once('value');
            const todasRecorrencias = recorrenciasSnap.val() || {};

            // 4. Preenche com campos vazios se houver menos que o m√°ximo
            while (dadosSalvos.length < maxCompromissos) {
                dadosSalvos.push({ texto: '', hora: '', tachado: false, selecionado: false });
            }
            dadosSalvos = dadosSalvos.slice(0, maxCompromissos); // Garante o limite

            // 5. Calcula quais recorrentes devem aparecer HOJE
            const textosJaNaAgenda = new Set(dadosSalvos.map(d => d.texto).filter(Boolean));
            const slotsVaziosIndices = [];
            dadosSalvos.forEach((d, i) => {
                if (!d.texto) slotsVaziosIndices.push(i);
            });

            for (const id in todasRecorrencias) {
                const regra = { ...todasRecorrencias[id], idRecorrente: id, isRecorrente: true };
                
                // Se o texto j√° existe na agenda do dia (foi modificado/tachado), n√£o mostra a regra
                if (textosJaNaAgenda.has(regra.texto)) {
                    continue;
                }

                if (deveAparecerNesteDia(regra, diaSelecionado)) {
                    if (slotsVaziosIndices.length > 0) {
                        const index = slotsVaziosIndices.shift(); // Pega o primeiro slot vazio
                        // Injeta o item recorrente no slot vazio
                        dadosSalvos[index] = { ...regra, tachado: false, selecionado: false };
                    } else {
                        // Opcional: Logar que n√£o h√° mais espa√ßo para recorrentes
                        // console.log("Sem espa√ßo para o item recorrente:", regra.texto);
                    }
                }
            }

            // 6. Renderiza todos os compromissos (normais e recorrentes injetados)
            dadosSalvos.forEach(item => {
                compromissos.appendChild(criarCampoCompromisso(item, data)); // Passa a data para a fun√ß√£o
            });

            section.appendChild(compromissos);
            agendaEl.appendChild(section);
        }

        /* Salvamento da agenda (SEM MODIFICA√á√ÉO, MAS IMPORTANTE) */
        // Esta fun√ß√£o salva o estado ATUAL dos 20 campos.
        // Se um item recorrente foi "tachado", ele √© salvo como um item normal,
        // o que o "congela" e faz com que a regra de recorr√™ncia seja ignorada
        // na pr√≥xima vez (override). Isso √© o comportamento desejado.
        function salvarAgenda() {
            const data = dataInput.value;
            const section = document.querySelector('.date-section');
            if (!section) return;

            const textos = [];
            section.querySelectorAll('.commitment').forEach(div => {
                const input = div.querySelector('input[type=text]');
                const checkbox = div.querySelector('input[type=checkbox]');
                
                // Pega o item "original" que foi usado para criar este campo
                // Se for recorrente, n√£o salvamos a regra, apenas o estado atual
                const itemOriginal = div._agendaItem || {}; 

                textos.push({
                    texto: input.value,
                    hora: '', // Hora n√£o est√° sendo usada/salva
                    tachado: input.classList.contains('done'),
                    selecionado: checkbox.checked
                    // N√£o salvamos 'isRecorrente' etc. no n√≥ 'agenda/data'
                });
            });

            database.ref('agenda/' + data).set(textos);
        }

        /* Cria um campo de compromisso (VERS√ÉO MODIFICADA) */
        function criarCampoCompromisso(item = { texto: '', hora: '', tachado: false, selecionado: false }, dataAtual) {
            const div = document.createElement('div');
            div.className = 'commitment';
            
            // Armazena a refer√™ncia do item original no elemento DOM
            // para ser usado nos listeners de OK e Excluir
            div._agendaItem = item; 

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = item.selecionado;
            checkbox.addEventListener('change', () => {
                div.classList.toggle('checked', checkbox.checked);
                salvarAgenda(); // Salva o estado de sele√ß√£o
            });

            if (item.selecionado) {
                div.classList.add('checked');
            }

            const input = document.createElement('input');
            input.type = 'text';
            input.value = item.texto || '';
            if (item.tachado) input.classList.add('done');
            
            // Listeners do input
            input.addEventListener('input', salvarComDelay);
            input.addEventListener('input', toUpperOnInput);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const allInputs = [...document.querySelectorAll('.commitment input[type=text]')];
                    const idx = allInputs.indexOf(input);
                    const next = allInputs[idx + 1];
                    if (next) next.focus();
                }
            });

            const okBtn = document.createElement('button');
            okBtn.textContent = 'OK';
            
            // L√≥gica do Bot√£o OK
            okBtn.onclick = () => {
                input.classList.toggle('done');
                // Ao "tachar" (OK), o item (recorrente ou n√£o) 
                // ser√° salvo permanentemente na agenda do dia pela fun√ß√£o salvarAgenda()
                salvarAgenda(); 
            };

            const delBtn = document.createElement('button');
            delBtn.textContent = 'Excluir';
            
            // L√≥gica do Bot√£o Excluir (MODIFICADA)
            delBtn.onclick = () => {
                if (item.isRecorrente) {
                    // Se for recorrente, abre o modal de exclus√£o
                    abrirModalExcluirRecorrente(item, dataAtual);
                } else {
                    // Se for normal, apenas limpa o campo e salva
                    input.value = '';
                    input.classList.remove('done');
                    checkbox.checked = false;
                    div.classList.remove('checked');
                    salvarAgenda();
                }
            };
            
            // Adiciona indicador visual para recorrentes
            if (item.isRecorrente) {
                div.classList.add('recorrente');
                okBtn.textContent = 'üîÑ'; // Emoji para indicar que √© um item recorrente
                okBtn.title = 'Concluir (transforma em item normal neste dia)';
                delBtn.title = 'Excluir (abrir√° op√ß√µes de recorr√™ncia)';
            }


            div.appendChild(okBtn);
            div.appendChild(input);
            div.appendChild(checkbox);
            div.appendChild(delBtn);

            return div;
        }

        /**
         * ==================================================================
         * FIM DAS FUN√á√ïES PRINCIPAIS MODIFICADAS
         * ==================================================================
         */

        /* Adiciona um novo campo de compromisso */
        function adicionarCompromisso() {
            const compromissos = document.querySelector('.commitments');
            
            // Procura o primeiro campo vazio
            const campoVazio = [...compromissos.children].find(div => !div.querySelector('input[type=text]').value);
            
            if (campoVazio) {
                 // Foca no primeiro campo vazio
                campoVazio.querySelector('input[type=text]').focus();
            } else if (compromissos.children.length < maxCompromissos) {
                // Adiciona um novo se n√£o houver vazios e houver espa√ßo
                const novoCampo = criarCampoCompromisso({}, dataInput.value); // Passa a data
                compromissos.appendChild(novoCampo);
                novoCampo.querySelector('input[type=text]').focus();
            }
        }

        function organizarAgenda() {
            const compromissosDiv = document.querySelector('.commitments');
            if (!compromissosDiv) return;

            // 1. Coletar todos os dados dos campos que est√£o preenchidos
            const dadosPreenchidos = [];
            const todosOsCampos = compromissosDiv.querySelectorAll('.commitment');

            todosOsCampos.forEach(div => {
                const input = div.querySelector('input[type="text"]');
                if (input.value.trim() !== '') {
                    // Pega o item original (pode ser recorrente ou n√£o)
                    const item = div._agendaItem || {};
                    const checkbox = div.querySelector('input[type="checkbox"]');
                    
                    dadosPreenchidos.push({
                        texto: input.value,
                        tachado: input.classList.contains('done'),
                        selecionado: checkbox.checked,
                        // Preserva a informa√ß√£o de recorr√™ncia se ela existir
                        isRecorrente: item.isRecorrente,
                        idRecorrente: item.idRecorrente,
                        startDate: item.startDate,
                        frequencia: item.frequencia
                    });
                }
            });

            // 2. Limpa todos os campos (visualmente)
            todosOsCampos.forEach((div, index) => {
                const input = div.querySelector('input[type="text"]');
                const checkbox = div.querySelector('input[type="checkbox"]');
                input.value = '';
                checkbox.checked = false;
                input.classList.remove('done');
                div.classList.remove('checked', 'recorrente');
                div.querySelector('button').textContent = 'OK'; // Reseta o bot√£o
                div._agendaItem = { texto: '', hora: '', tachado: false, selecionado: false }; // Reseta o item
            });

            // 3. Reescreve os dados nos campos desde o in√≠cio
            dadosPreenchidos.forEach((dados, index) => {
                 if (index < todosOsCampos.length) {
                    const div = todosOsCampos[index];
                    const input = div.querySelector('input[type="text"]');
                    const checkbox = div.querySelector('input[type="checkbox"]');
                    
                    input.value = dados.texto;
                    checkbox.checked = dados.selecionado;
                    
                    // Ajusta as classes CSS (para visual)
                    input.classList.toggle('done', dados.tachado);
                    div.classList.toggle('checked', dados.selecionado);
                    
                    // Re-associa o item original
                    div._agendaItem = dados; 
                    
                    // Re-aplica estilo recorrente se for o caso
                    if(dados.isRecorrente) {
                        div.classList.add('recorrente');
                        div.querySelector('button').textContent = 'üîÑ';
                    }
                 }
            });

            // 4. Salvar o novo estado no Firebase
            salvarAgenda();
        }

        /* Pesquisa por compromissos no Firebase */
        async function pesquisarCompromisso() {
            const termo = searchEl.value.trim().toLowerCase();
            searchResultsEl.innerHTML = '';
            if (termo.length < 3) return;

            const resultados = [];
            // 1. Pesquisa na 'agenda'
            const snapshotAgenda = await database.ref('agenda').once('value');
            const todasAsAgendas = snapshotAgenda.val();
            if (todasAsAgendas) {
                for (const data in todasAsAgendas) {
                    const dadosDoDia = todasAsAgendas[data] || [];
                    dadosDoDia.forEach((item, index) => {
                        if (item.texto && item.texto.toLowerCase().includes(termo)) {
                            resultados.push({ data, index, item, tipo: 'agenda' });
                        }
                    });
                }
            }

            // 2. Pesquisa em 'recorrencias'
            const snapshotRec = await database.ref('recorrencias').once('value');
            const todasRecorrencias = snapshotRec.val();
            if (todasRecorrencias) {
                for (const id in todasRecorrencias) {
                    const regra = todasRecorrencias[id];
                    if (regra.texto && regra.texto.toLowerCase().includes(termo)) {
                        resultados.push({
                            data: regra.startDate,
                            index: 0,
                            item: regra,
                            tipo: 'recorrente'
                        });
                    }
                }
            }


            if (resultados.length > 0) {
                resultados.forEach(({ data, index, item, tipo }) => {
                    const divResultado = document.createElement('div');
                    let prefixo = (tipo === 'recorrente') ? 'üîÑ Recorrente (in√≠cio):' : 'Dia:';
                    divResultado.textContent = `${prefixo} ${data} - ${item.texto}`;
                    
                    divResultado.onclick = () => {
                        dataInput.value = data; // Pula para o dia (ou dia de in√≠cio)
                        carregarAgenda().then(() => {
                            if (tipo === 'agenda') {
                                // Tenta encontrar o item espec√≠fico
                                const compromisso = agendaEl.querySelectorAll('.commitment')[index];
                                if (compromisso) {
                                    compromisso.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    compromisso.classList.add('destaque');
                                    setTimeout(() => compromisso.classList.remove('destaque'), 2000);
                                }
                            } else {
                                // Para recorrente, apenas destaca o primeiro que encontrar com o texto
                                const compromisso = [...agendaEl.querySelectorAll('.commitment input[type=text]')]
                                                    .find(input => input.value === item.texto);
                                if (compromisso) {
                                    const parent = compromisso.closest('.commitment');
                                    parent.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    parent.classList.add('destaque');
                                    setTimeout(() => parent.classList.remove('destaque'), 2000);
                                }
                            }
                        });
                    };
                    searchResultsEl.appendChild(divResultado);
                });
            } else {
                searchResultsEl.textContent = 'Nenhum compromisso encontrado.';
            }
        }


        /* Limpa busca */
        function limparBusca() {
            searchEl.value = '';
            searchResultsEl.innerHTML = '';
        }

        /* Exporta para TXT */
        async function exportarParaTXT(data) {
            // Re-usa a l√≥gica de carregamento para obter a lista combinada
            const diaSelecionado = new Date(data + 'T12:00:00');
            const snapshot = await database.ref('agenda/' + data).once('value');
            let dadosSalvos = snapshot.val() || [];
            
            const recorrenciasSnap = await database.ref('recorrencias').once('value');
            const todasRecorrencias = recorrenciasSnap.val() || {};

            while (dadosSalvos.length < maxCompromissos) {
                dadosSalvos.push({ texto: '', hora: '', tachado: false, selecionado: false });
            }
            dadosSalvos = dadosSalvos.slice(0, maxCompromissos);

            const textosJaNaAgenda = new Set(dadosSalvos.map(d => d.texto).filter(Boolean));
            const slotsVaziosIndices = [];
            dadosSalvos.forEach((d, i) => {
                if (!d.texto) slotsVaziosIndices.push(i);
            });

            for (const id in todasRecorrencias) {
                const regra = { ...todasRecorrencias[id], idRecorrente: id, isRecorrente: true };
                if (textosJaNaAgenda.has(regra.texto)) continue;
                if (deveAparecerNesteDia(regra, diaSelecionado)) {
                    if (slotsVaziosIndices.length > 0) {
                        const index = slotsVaziosIndices.shift();
                        dadosSalvos[index] = { ...regra, tachado: false, selecionado: false };
                    }
                }
            }

            // Agora 'dadosSalvos' cont√©m a lista completa do dia
            let conteudo = 'Agenda de ' + data + '\n\n';
            let contador = 1;
            dadosSalvos.forEach((item) => {
                if (item.texto) {
                    let sufixo = item.tachado ? ' (Conclu√≠do)' : '';
                    if (item.isRecorrente && !item.tachado) sufixo += ' (Recorrente)';
                    
                    conteudo += (contador++) + '. ' + item.texto + sufixo + '\n';
                }
            });


            const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `agenda_${data}.txt`;
            a.click();
        }

        /* ==================================================================
         FUN√á√ÉO CORRIGIDA (COPIAR)
        ==================================================================
        */
        function copiarCompromissos() {
            bufferCopiados = [];
            const section = document.querySelector('.date-section');
            if (!section) return;
            const compromissos = section.querySelectorAll('.commitment');
            
            compromissos.forEach(div => {
                const input = div.querySelector('input[type="text"]');
                
                // L√ìGICA ORIGINAL RESTAURADA:
                // Copia o item se ele tiver texto e N√ÉO estiver tachado ('done')
                if (input.value.trim() !== '' && !input.classList.contains('done')) {
                    bufferCopiados.push(input.value);
                    input.classList.add('done'); // Tacha o item ap√≥s copiar
                }
            });
            
            salvarAgenda(); // Salva o novo estado (com os itens tachados)
        }

        /* ==================================================================
         FUN√á√ÉO COLAR (Sem altera√ß√µes, j√° estava correta)
        ==================================================================
        */
        function colarCompromissos() {
            if (!bufferCopiados.length) return;
            const compromissosDiv = document.querySelector('.commitments');
            if (!compromissosDiv) return;

            let idxBuffer = 0;

            function encontrarOuAdicionarCampoVazio() {
                // Prioriza campos vazios
                const vazio = [...compromissosDiv.children].find(div => !div.querySelector('input[type=text]').value);
                if (vazio) return vazio;
                
                // Se n√£o houver vazios, mas houver espa√ßo, adiciona
                if (compromissosDiv.children.length < maxCompromissos) {
                    const novo = criarCampoCompromisso({}, dataInput.value); // Passa a data
                    compromissosDiv.appendChild(novo);
                    return novo;
                }
                return null;
            }

            while (idxBuffer < bufferCopiados.length) {
                const campo = encontrarOuAdicionarCampoVazio();
                if (!campo) break; // Para se a agenda estiver cheia
                const input = campo.querySelector('input[type=text]');
                const checkbox = campo.querySelector('input[type="checkbox"]');
                input.value = bufferCopiados[idxBuffer++];
                input.classList.remove('done'); // Garante que o item colado n√£o venha tachado
                checkbox.checked = false;
                campo.classList.remove('checked');
            }
            salvarAgenda();
        }

        /* Fun√ß√µes de CPF (Ocultadas para economizar espa√ßo, mas ainda presentes no seu c√≥digo) */
        function validarCPF(cpf) { if (!cpf || cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false; let soma = 0, resto; for (let i = 1; i <= 9; i++) soma += parseInt(cpf[i - 1]) * (11 - i); resto = (soma * 10) % 11; if (resto === 10 || resto === 11) resto = 0; if (resto !== parseInt(cpf[9])) return false; soma = 0; for (let i = 1; i <= 10; i++) soma += parseInt(cpf[i - 1]) * (12 - i); resto = (soma * 10) % 11; if (resto === 10 || resto === 11) resto = 0; return resto === parseInt(cpf[10]); }
        /* document.getElementById('cpf').addEventListener('input', () => { const raw = document.getElementById('cpf').value.replace(/\D/g, ''); const status = document.getElementById('cpfStatus'); const valido = validarCPF(raw); status.textContent = valido ? 'CPF v√°lido' : 'CPF inv√°lido'; status.className = valido ? 'valid' : 'invalid'; }); function copiarCPF() { let raw = document.getElementById('cpf').value.replace(/\D/g, ''); if (validarCPF(raw)) { let formatado = raw.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4"); navigator.clipboard.writeText(formatado); } } function limparCPF() { document.getElementById('cpf').value = ''; document.getElementById('cpfStatus').textContent = ''; document.getElementById('cpfStatus').className = ''; } */

        /* Fun√ß√µes das Notas Fixas com Firebase */
        async function carregarNotasFixas() {
            const snapshot = await database.ref('notasFixas').once('value');
            notasFixasEl.value = snapshot.val() || '';
        }

        notasFixasEl.addEventListener('input', () => {
            // Aplica a capitaliza√ß√£o ao digitar nas notas
            toUpperOnInput({ target: notasFixasEl }); // <-- APLICA√á√ÉO DA CORRE√á√ÉO AQUI
            // Salva no Firebase
            database.ref('notasFixas').set(notasFixasEl.value);
        });

        /* --- ALARMES PERSISTENTES --- */
        let alarmTimeouts = {};
        let alarmBlinkInterval = null;
        let originalTitle = document.title;
        let triggeredAlarms = new Set();

        async function loadAlarms() {
            const snapshot = await database.ref('alarms').once('value');
            const savedAlarms = snapshot.val();
            if (savedAlarms) {
                for (const id in savedAlarms) {
                    const alarmData = savedAlarms[id];
                    if (alarmData && alarmData.time && alarmData.message) {
                        document.getElementById(`alarmMessage${id}`).value = alarmData.message;
                        document.getElementById(`alarmTime${id}`).value = alarmData.time;
                        setAlarm(id, true);
                    }
                }
            }

            // Aplica o listener de capitaliza√ß√£o nos inputs de alarme
            document.querySelectorAll('#alarmes input[type="text"]').forEach(input => {
                input.addEventListener('input', toUpperOnInput); // <-- APLICA√á√ÉO DA CORRE√á√ÉO AQUI
            });
        }

        // ==================================================================
        // ============ FUN√á√ÉO setAlarm (Vers√£o Robusta) ============
        // ==================================================================
        function setAlarm(id, silent = false) {
            const msgEl = document.getElementById(`alarmMessage${id}`);
            const timeEl = document.getElementById(`alarmTime${id}`);
            const msg = msgEl.value.trim();
            const time = timeEl.value;

            // Pega o elemento de feedback
            const feedbackEl = document.getElementById('alarm-feedback');

            // --- ALTERA√á√ÉO DE ROBUSTEZ ---
            // Limpa o feedback S√ì SE o elemento existir
            if (feedbackEl) {
                feedbackEl.textContent = '';
            }
            // --- FIM DA ALTERA√á√ÉO ---

            if (!msg || !time) {
                if (!silent) alert("Preencha a frase e o hor√°rio do alarme " + id);
                return;
            }

            database.ref(`alarms/${id}`).set({ message: msg, time: time });

            if (alarmTimeouts[id]) {
                clearTimeout(alarmTimeouts[id]);
            }

            const [h, m] = time.split(':').map(Number);
            const now = new Date();
            const alarm = new Date(now);
            alarm.setHours(h, m, 0, 0);

            if (alarm < now) {
                alarm.setDate(alarm.getDate() + 1);
            }

            const diff = alarm.getTime() - now.getTime();

            // --- ALTERA√á√ÉO DE ROBUSTEZ ---
            // S√≥ mostra o feedback se n√£o for silencioso E o elemento existir
            if (!silent && feedbackEl) { // <--- Adicionado "&& feedbackEl"
                const totalMinutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                feedbackEl.textContent = `Alarme programado para daqui a ${hours}h e ${minutes}min.`;

                // Limpa a mensagem ap√≥s 4 segundos
                setTimeout(() => {
                    // Limpa de novo, S√ì SE o elemento existir
                    if (feedbackEl) {
                        feedbackEl.textContent = '';
                    }
                }, 4000);
            }
            // --- FIM DA ALTERA√á√ÉO ---

            alarmTimeouts[id] = setTimeout(() => triggerAlarm(msg, id), diff);
        }

        // ==================================================================
        // ============ FUN√á√ÉO clearAlarm (Vers√£o Robusta) ============
        // ==================================================================
        function clearAlarm(id) {
            if (alarmTimeouts[id]) {
                clearTimeout(alarmTimeouts[id]);
                delete alarmTimeouts[id];
            }
            document.getElementById(`alarmMessage${id}`).value = '';
            document.getElementById(`alarmTime${id}`).value = '';

            database.ref(`alarms/${id}`).remove();

            // --- ALTERA√á√ÉO DE ROBUSTEZ ---
            // Limpa a mensagem de feedback S√ì SE o elemento existir
            const feedbackEl = document.getElementById('alarm-feedback');
            if (feedbackEl) {
                feedbackEl.textContent = '';
            }
            // --- FIM DA ALTERA√á√ÉO ---
        }

        function triggerAlarm(message, id) {
            if (triggeredAlarms.has(id)) return;
            triggeredAlarms.add(id);

            alert("‚è∞ ALARME " + id + ": " + message);

            if (!alarmBlinkInterval) {
                let visible = true;
                alarmBlinkInterval = setInterval(() => {
                    document.title = visible ? "‚ö†Ô∏è ALARME ‚ö†Ô∏è" : originalTitle;
                    visible = !visible;
                }, 800);
                window.addEventListener('focus', stopAlarmBlink, { once: true });
                window.addEventListener('click', stopAlarmBlink, { once: true });
            }

            database.ref(`alarms/${id}`).remove();
            document.getElementById(`alarmMessage${id}`).value = '';
            document.getElementById(`alarmTime${id}`).value = '';
        }

        function stopAlarmBlink() {
            if (alarmBlinkInterval) {
                clearInterval(alarmBlinkInterval);
                alarmBlinkInterval = null;
            }
            document.title = originalTitle;
            triggeredAlarms.clear();
            window.removeEventListener('focus', stopAlarmBlink);
            window.removeEventListener('click', stopAlarmBlink);
        }


        /**
         * ==================================================================
         * IN√çCIO DAS NOVAS FUN√á√ïES DE RECORR√äNCIA
         * ==================================================================
         */

        // Elementos dos Modais
        const modalRecorrente = document.getElementById('modalRecorrente');
        const modalExcluirRecorrente = document.getElementById('modalExcluirRecorrente');
        const recorrenteTextoEl = document.getElementById('recorrenteTexto');

        // Aplica o listener de capitaliza√ß√£o tamb√©m no modal
        recorrenteTextoEl.addEventListener('input', toUpperOnInput);

        // --- Listeners do Modal de NOVO RECORRENTE ---
        document.getElementById('cancelarRecorrenteBtn').addEventListener('click', () => {
            modalRecorrente.style.display = 'none';
        });

        document.getElementById('salvarRecorrenteBtn').addEventListener('click', () => {
            const texto = recorrenteTextoEl.value.trim().toUpperCase();
            if (!texto) {
                alert('Por favor, digite a descri√ß√£o do compromisso.');
                return;
            }
            
            const frequenciaEl = document.querySelector('input[name="frequencia"]:checked');
            if (!frequenciaEl) {
                alert('Por favor, selecione uma frequ√™ncia.');
                return;
            }
            
            const frequencia = frequenciaEl.value;
            const startDate = dataInput.value; // Come√ßa no dia selecionado

            // Cria um ID √∫nico no Firebase
            const novoId = database.ref('recorrencias').push().key;

            const regra = {
                texto: texto,
                startDate: startDate,
                frequencia: frequencia,
                excecoes: {} // N√≥ para armazenar exce√ß√µes de dias
            };

            database.ref('recorrencias/' + novoId).set(regra).then(() => {
                modalRecorrente.style.display = 'none';
                carregarAgenda(); // Recarrega a agenda para mostrar o novo item
            });
        });


        // --- Fun√ß√µes e Listeners do Modal de EXCLUIR RECORRENTE ---
        
        // Vari√°veis tempor√°rias para guardar o item a ser exclu√≠do
        let itemParaExcluir = null;
        let dataParaExcluir = null;

        function abrirModalExcluirRecorrente(item, data) {
            itemParaExcluir = item;
            dataParaExcluir = data;
            document.getElementById('excluirRecorrenteTexto').textContent = `Como deseja excluir "${item.texto}"?`;
            modalExcluirRecorrente.style.display = 'flex';
        }

        document.getElementById('cancelarExcluirBtn').addEventListener('click', () => {
            modalExcluirRecorrente.style.display = 'none';
            itemParaExcluir = null;
            dataParaExcluir = null;
        });

        // Bot√£o "Excluir somente esta"
        document.getElementById('excluirUmBtn').addEventListener('click', () => {
            if (!itemParaExcluir || !dataParaExcluir) return;

            const id = itemParaExcluir.idRecorrente;
            const data = dataParaExcluir;

            // Adiciona a data atual ao n√≥ de exce√ß√µes da regra
            database.ref(`recorrencias/${id}/excecoes/${data}`).set(true).then(() => {
                modalExcluirRecorrente.style.display = 'none';
                carregarAgenda(); // Recarrega para o item sumir
            });
        });

        // Bot√£o "Excluir esta e futuras"
        document.getElementById('excluirFuturosBtn').addEventListener('click', () => {
            if (!itemParaExcluir || !dataParaExcluir) return;

            const id = itemParaExcluir.idRecorrente;
            
            // Define uma 'endDate' para a regra, sendo o dia anterior ao atual
            const d = new Date(dataParaExcluir + "T12:00:00");
            d.setDate(d.getDate() - 1);
            const dataFim = d.toISOString().split('T')[0];

            database.ref(`recorrencias/${id}/endDate`).set(dataFim).then(() => {
                modalExcluirRecorrente.style.display = 'none';
                carregarAgenda(); // Recarrega para o item sumir
            });
        });


        // --- Fun√ß√£o Helper: O "C√©rebro" da Recorr√™ncia ---
        
        /**
         * Verifica se uma regra de recorr√™ncia deve aparecer em um dia espec√≠fico.
         * @param {object} regra - O objeto da regra de recorr√™ncia.
         * @param {Date} diaSelecionado - O objeto Date do dia a ser verificado.
         */
        function deveAparecerNesteDia(regra, diaSelecionado) {
            // Ajusta o startDate para T12 para evitar problemas de fuso
            const startDate = new Date(regra.startDate + 'T12:00:00');
            
            // 1. Se o dia for ANTERIOR ao in√≠cio, n√£o mostra
            if (diaSelecionado < startDate) {
                return false;
            }

            // 2. Se o dia for DEPOIS do fim, n√£o mostra
            if (regra.endDate) {
                const endDate = new Date(regra.endDate + 'T12:00:00');
                if (diaSelecionado > endDate) {
                    return false;
                }
            }

            // 3. Se o dia for uma EXCE√á√ÉO, n√£o mostra
            const dataFormatada = diaSelecionado.toISOString().split('T')[0];
            if (regra.excecoes && regra.excecoes[dataFormatada]) {
                return false;
            }

            // 4. Verifica a Frequ√™ncia
            const diaInicio = startDate.getDate();
            const diaSemanaInicio = startDate.getDay();
            const mesInicio = startDate.getMonth();

            const diaSel = diaSelecionado.getDate();
            const diaSemanaSel = diaSelecionado.getDay();
            const mesSel = diaSelecionado.getMonth();

            switch (regra.frequencia) {
                case 'diario':
                    return true; // J√° passou pelas checagens de in√≠cio, fim e exce√ß√£o
                
                case 'semanal':
                    return diaSemanaSel === diaSemanaInicio;
                
                case 'mensal':
                    return diaSel === diaInicio;
                
                case 'anual':
                    return diaSel === diaInicio && mesSel === mesInicio;
                
                default:
                    return false;
            }
        }

        /**
         * ==================================================================
         * FIM DAS NOVAS FUN√á√ïES DE RECORR√äNCIA
         * ==================================================================
         */

    </script>
</body>
</html>
