<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda do Fofo</title>
  <style>
    /* Seu CSS original vem aqui - Nenhuma mudan√ßa necess√°ria */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #fff;
      color: #000;
    }
    .container {
      display: flex;
      flex-direction: column;
    }
    @media (min-width: 768px) {
      .container {
        flex-direction: row;
        min-height: 100vh;
      }
    }
    .left-panel,
    .right-panel {
      padding: 20px;
    }
    .left-panel {
      flex: 2;
      border-right: 1px solid #ccc;
    }
    .right-panel {
      flex: 1;
    }
    .calendar-section {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .calendar-section button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .day-nav {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: -10px 0 10px 0;
    }
    .day-nav button {
      padding: 2px 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .search-area {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-area input {
      flex: 1;
      padding: 5px;
      min-width: 120px;
    }
    .search-results {
      background-color: #fff;
      border: 1px solid transparent;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    .search-results div {
      cursor: pointer;
      padding: 4px;
    }
    .search-results div:hover {
      background-color: #eee;
    }
    .destaque {
      background: yellow;
    }
    .commitment {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      flex-wrap: wrap;
      padding: 5px;
    }
    .commitment input[type="text"] {
      flex: 1;
      padding: 5px;
      margin-right: 5px;
      min-width: 120px;
    }
    .commitment button {
      margin-left: 3px;
    }
    .done {
      text-decoration: line-through;
      color: gray;
    }
    #cpfStatus.valid {
      color: blue;
    }
    #cpfStatus.invalid {
      color: red;
    }
    .commitment.checked {
      background-color: #d1e7ff;
    }
    .commitment:nth-child(even) {
      background-color: #f2f2f2;
    }
    .commitment:nth-child(even).checked {
      background-color: #aed6f1;
    }

    /* === PASSO 4: CSS da tela de login e esconder conte√∫do inicialmente === */
    #main-container {
      display: none; /* Esconde a agenda por padr√£o at√© logar */
    }
    #login-container {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background-color: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #login-box {
      background: #ffffff;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
      width: min(90%, 360px);
    }
    #login-box h2 {
      margin: 0 0 10px 0;
    }
    #login-box input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 12px;
      font-size: 16px;
    }
    #login-box button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
    #loginError {
      min-height: 20px;
      margin-top: 8px;
      color: red;
    }
  </style>

  <!-- Scripts do Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

  <!-- === PASSO 3: Tela de Login === -->
  <div id="login-container">
    <div id="login-box">
      <h2>Acessar Agenda</h2>
      <input type="password" id="passwordInput" placeholder="Senha" />
      <button id="loginBtn">Entrar</button>
      <div id="loginError"></div>
    </div>
  </div>

  <!-- Envolvemos o conte√∫do original dentro de #main-container -->
  <div id="main-container" class="container">
    <div class="left-panel">
      <h1>Agenda do Fofo</h1>
      <div class="calendar-section">
        <input type="date" id="dataSelecionada" />
        <button id="hojeBtn" title="Hoje">üìÖ</button>
      </div>
      <div class="day-nav">
        <button id="prevDayBtn" title="Dia anterior">‚óÄ</button>
        <button id="nextDayBtn" title="Pr√≥ximo dia">‚ñ∂</button>
      </div>
      <div class="actions">
        <button id="novoBtn">Novo</button>
        <button id="copiarBtn">Copiar</button>
        <button id="colarBtn">Colar</button>
        <a href="https://luizcezarmelo.github.io/minha-agenda/laudosipi.html" target="_blank" style="text-decoration: none">
          <button type="button">Laudos de IPI</button>
        </a>
      </div>
      <div id="agenda"></div>
    </div>
    <div class="right-panel">
      <h2>Validador de CPF</h2>
      <div style="display: flex; gap: 5px; flex-wrap: wrap">
        <input type="text" id="cpf" placeholder="Digite o CPF" />
        <button onclick="limparCPF()" title="Limpar CPF">‚ùå</button>
      </div>
      <p id="cpfStatus"></p>
      <button onclick="copiarCPF()">Copiar</button>

      <h3>üîç Pesquisa</h3>
      <div class="search-area">
        <input type="text" id="search" placeholder="Pesquisar..." />
        <button onclick="limparBusca()">‚ùå</button>
      </div>
      <div id="searchResults" class="search-results"></div>

      <h3>üìù Lembretes:</h3>
      <textarea id="notasFixas" rows="20" style="width: 100%; resize: vertical"></textarea>
    </div>
  </div>

  <!-- === PASSO 5: Script com l√≥gica de login + seu c√≥digo original intacto === -->
  <script>
    // ‚úÖ SUA CONFIGURA√á√ÉO DO FIREBASE J√Å EST√Å INCLU√çDA AQUI
    const firebaseConfig = {
      apiKey: "AIzaSyDQOGFiqafMZh0ha6XW62P1DpIKJE8TBYc",
      authDomain: "agenda-online-7b71c.firebaseapp.com",
      // Adicionei a databaseURL que √© necess√°ria para o Realtime Database
      databaseURL: "https://agenda-online-7b71c-default-rtdb.firebaseio.com",
      projectId: "agenda-online-7b71c",
      storageBucket: "agenda-online-7b71c.appspot.com",
      messagingSenderId: "28125733214",
      appId: "1:28125733214:web:162d1cce5d14f55c24afcf",
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ---- L√ìGICA DE LOGIN (novo) ----
    const loginContainer = document.getElementById('login-container');
    const mainContainer  = document.getElementById('main-container');
    const passwordInput  = document.getElementById('passwordInput');
    const loginBtn       = document.getElementById('loginBtn');
    const loginError     = document.getElementById('loginError');

    async function hashString(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function tentarLogin() {
      const senhaDigitada = passwordInput.value;
      if (!senhaDigitada) {
        loginError.textContent = 'Por favor, digite a senha.';
        return;
      }
      loginError.textContent = '';

      const hashDigitado = await hashString(senhaDigitada);
      const snapshot = await database.ref('senha/hash').once('value');
      const hashSalvo = snapshot.val();

      if (hashDigitado === hashSalvo) {
        // Login ok: mostra a agenda e inicia listeners
        loginContainer.style.display = 'none';
        mainContainer.style.display = 'flex';
        iniciarAgenda();
      } else {
        loginError.textContent = 'Senha incorreta.';
      }
    }

    loginBtn.addEventListener('click', tentarLogin);
    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') tentarLogin();
    });
    // ---- FIM L√ìGICA DE LOGIN ----

    // Elementos principais e vari√°veis globais (SEU C√ìDIGO ORIGINAL)
    const agendaEl = document.getElementById("agenda");
    const searchEl = document.getElementById("search");
    const searchResultsEl = document.getElementById("searchResults");
    const dataInput = document.getElementById("dataSelecionada");
    const novoBtn = document.getElementById("novoBtn");
    const copiarBtn = document.getElementById("copiarBtn");
    const colarBtn = document.getElementById("colarBtn");
    const exportarBtn = document.getElementById("exportarBtn");
    const hojeBtn = document.getElementById("hojeBtn");
    const prevDayBtn = document.getElementById("prevDayBtn");
    const nextDayBtn = document.getElementById("nextDayBtn");
    const notasFixasEl = document.getElementById("notasFixas");

    const maxCompromissos = 20;
    let bufferCopiados = [];

    // Agora inicializamos tudo AP√ìS o login
    function iniciarAgenda() {
      // Configura√ß√£o inicial
      dataInput.value = new Date().toISOString().split("T")[0];
      carregarAgenda();
      carregarNotasFixas(); // Carrega as notas fixas ao iniciar

      /* Listeners de interface */
      dataInput.addEventListener("change", carregarAgenda);
      novoBtn.addEventListener("click", adicionarCompromisso);
      copiarBtn.addEventListener("click", copiarCompromissos);
      colarBtn.addEventListener("click", colarCompromissos);

      hojeBtn.addEventListener("click", () => {
        const hoje = new Date().toISOString().split("T")[0];
        dataInput.value = hoje;
        carregarAgenda();
      });
      prevDayBtn.addEventListener("click", () => {
        const d = new Date(dataInput.value);
        d.setDate(d.getDate() - 1);
        dataInput.value = d.toISOString().split("T")[0];
        carregarAgenda();
      });
      nextDayBtn.addEventListener("click", () => {
        const d = new Date(dataInput.value);
        d.setDate(d.getDate() + 1);
        dataInput.value = d.toISOString().split("T")[0];
        carregarAgenda();
      });
      searchEl.addEventListener("input", pesquisarCompromisso);

      // Salvar notas fixas no Firebase
      notasFixasEl.addEventListener("input", () => {
        database.ref("notasFixas").set(notasFixasEl.value);
      });

      /* Converte para mai√∫sculas */
      document.addEventListener("input", (e) => {
        if (e.target.matches("input[type='text'], textarea")) {
          const pos = e.target.selectionStart;
          e.target.value = e.target.value.toUpperCase();
          e.target.setSelectionRange(pos, pos);
        }
      });

      // Validador de CPF (mantido)
      document.getElementById("cpf").addEventListener("input", () => {
        const raw = document.getElementById("cpf").value.replace(/\D/g, "");
        const status = document.getElementById("cpfStatus");
        const valido = validarCPF(raw);
        status.textContent = valido ? "CPF v√°lido" : "CPF inv√°lido";
        status.className = valido ? "valid" : "invalid";
      });
    }

    /* Salvamento com delay */
    let debounceTimer;
    function salvarComDelay() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => salvarAgenda(), 1000); // Aumentei um pouco o delay para redes
    }

    /* Carregar agenda do dia selecionado */
    async function carregarAgenda() {
      const data = dataInput.value;
      agendaEl.innerHTML = ""; // Limpa a agenda atual

      const section = document.createElement("div");
      section.className = "date-section";
      section.dataset.data = data;

      const compromissos = document.createElement("div");
      compromissos.className = "commitments";

      // Busca os dados do Firebase
      const snapshot = await database.ref("agenda/" + data).once("value");
      let dadosSalvos = snapshot.val() || [];

      while (dadosSalvos.length < 15)
        dadosSalvos.push({ texto: "", hora: "", tachado: false, selecionado: f
