<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Controle de Despesas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url(https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap);
        :root {
            --bg-color: #f4f7f9;
            --surface-color: #ffffff;
            --text-color-primary: #212529;
            --text-color-secondary: #6c757d;
            --border-color: #e9ecef;
            --accent-color: #007bff;
            --nubank-color: #820ad1;
            --c6-color: #2b2b2b;
            --danger-color: #dc3545;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px
        }
        body { font-family: Inter, sans-serif; background-color: var(--bg-color); color: var(--text-color-primary); margin: 0; padding: 2rem 1.5rem; -webkit-font-smoothing: antialiased; font-size: 14px }
        #login-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, .6); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #login-box { background: var(--surface-color); padding: 32px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); text-align: center; width: 90%; max-width: 340px; }
        #login-message { margin-bottom: 16px; font-size: 0.95rem; color: var(--text-color-secondary); }
        #passcode-input { width: calc(100% - 24px); padding: 12px; font-size: 2.5rem; text-align: center; letter-spacing: .5em; border: 2px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 24px; background-color: var(--bg-color); outline: none; }
        #login-button { width: 100%; padding: 14px; background-color: var(--accent-color); color: #fff; border: none; border-radius: var(--border-radius); font-size: 1rem; font-weight: 600; cursor: pointer; }
        .container { max-width: 1600px; margin: auto; display: none; }
        h1 { font-size: 2.2rem; font-weight: 700; text-align: center; margin-bottom: 2rem; color: var(--text-color-primary); }
        h2 { font-size: 1.25rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 10px; color: var(--text-color-primary); }
        h3 { font-size: 1rem; font-weight: 500; margin-bottom: 8px; color: var(--text-color-secondary); }
        .month-navigation { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 2rem; gap: 1rem; background: var(--surface-color); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm) }
        .nav-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap }
        #currentMonthYear { margin: 0 15px; font-size: 1.3rem; font-weight: 600; color: var(--text-color-primary); }
        .month-navigation button { background-color: var(--surface-color); border: 1px solid var(--border-color); cursor: pointer; border-radius: var(--border-radius); transition: 0.2s; height: 42px; padding: 0 16px; font-size: .9rem; display: flex; align-items: center; gap: 8px; color: var(--text-color-secondary); font-weight: 500; }
        .month-navigation button:hover { border-color: var(--accent-color); color: var(--accent-color); background-color: #f8fbff; }
        #clearAllBtn { color: var(--danger-color); border-color: var(--danger-color) }
        #clearAllBtn:hover { background-color: var(--danger-color); color: #fff }
        .summary-box { background-color: var(--surface-color); padding: 20px; border-radius: var(--border-radius); text-align: center; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); margin-bottom: 2rem }
        #totalGeral { font-size: 1.8rem; font-weight: 800; color: #000; letter-spacing: -0.5px; }
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem }
        .grid-item { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; }
        .card-header-wrapper { padding: 15px 20px; border-bottom: 1px solid var(--border-color) }
        .nubank-header { border-top: 5px solid var(--nubank-color) }
        .c6-header { border-top: 5px solid var(--c6-color) }
        .full-width-item { grid-column: 1/-1 }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-size: 0.75rem; text-transform: uppercase; color: var(--text-color-secondary); letter-spacing: 0.8px; font-weight: 600; }
        td[contenteditable=true]:focus { outline: 0; background-color: #f0f7ff; box-shadow: inset 0 0 0 1px var(--accent-color); }
        tfoot td { font-weight: 700; background: #fafafa; color: var(--text-color-primary); }
        #status { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: #212529; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 0.85rem; opacity: 0; transition: 0.3s; z-index: 1001; pointer-events: none; }
        #status.show { opacity: 1; }
        @media (max-width:1400px) { .grid-container { grid-template-columns: repeat(2, 1fr) } }
        @media (max-width:768px) { .grid-container { grid-template-columns: 1fr } .month-navigation { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div id="login-box">
        <h2>Autenticação</h2>
        <p id="login-message">Digite o código de acesso para continuar.</p>
        <input type="password" id="passcode-input" maxlength="4" inputmode="numeric">
        <button id="login-button">Acessar Sistema</button>
    </div>
</div>

<div class="container">
    <h1>Controle de Despesas</h1>
    
    <div class="month-navigation">
        <div class="nav-group">
            <button id="prevMonthBtn"><i class="fa-solid fa-chevron-left"></i></button>
            <h2 id="currentMonthYear"></h2>
            <button id="nextMonthBtn"><i class="fa-solid fa-chevron-right"></i></button>
            <button id="todayBtn"><i class="fa-solid fa-calendar-day"></i> Hoje</button>
        </div>
        <div class="nav-group">
            <input type="file" id="importFile" style="display:none" accept=".json">
            <button id="restoreBtn"><i class="fa-solid fa-upload"></i> Restaurar JSON</button>
            <button id="saveBtn"><i class="fa-solid fa-download"></i> Backup </button>
            <button id="clearAllBtn"><i class="fa-solid fa-trash-can"></i> Limpar mês</button>
        </div>
    </div>

    <div class="summary-box">
        <h3>Total do Mês</h3>
        <div id="totalGeral">R$ 0,00</div>
    </div>

    <div class="grid-container">
        <div class="grid-item">
            <div class="card-header-wrapper"><h2><i class="fa-solid fa-piggy-bank"></i> Fixas</h2></div>
            <table>
                <thead><tr><th>Descrição</th><th>Valor</th><th style="width: 40px;">Ok</th></tr></thead>
                <tbody id="fixedTbody"></tbody>
                <tfoot><tr><td>Total</td><td id="fixedTotal" colspan="2">R$ 0,00</td></tr></tfoot>
            </table>
        </div>
        <div class="grid-item">
            <div class="card-header-wrapper nubank-header"><h2><i class="fa-solid fa-credit-card"></i> Nubank</h2></div>
            <table>
                <thead><tr><th>Descrição</th><th>Valor</th><th>Parc.</th><th style="width: 40px;">Ok</th></tr></thead>
                <tbody id="nubankTbody"></tbody>
                <tfoot><tr><td>Total</td><td id="nubankTotal" colspan="3">R$ 0,00</td></tr></tfoot>
            </table>
        </div>
        <div class="grid-item">
            <div class="card-header-wrapper c6-header"><h2><i class="fa-solid fa-credit-card"></i> C6 Bank</h2></div>
            <table>
                <thead><tr><th>Descrição</th><th>Valor</th><th>Parc.</th><th style="width: 40px;">Ok</th></tr></thead>
                <tbody id="c6Tbody"></tbody>
                <tfoot><tr><td>Total</td><td id="c6Total" colspan="3">R$ 0,00</td></tr></tfoot>
            </table>
        </div>
        <div class="grid-item">
            <div class="card-header-wrapper"><h2><i class="fa-solid fa-receipt"></i> Diversos</h2></div>
            <table>
                <thead><tr><th>Descrição</th><th>Valor</th><th>Parc.</th><th style="width: 40px;">Ok</th></tr></thead>
                <tbody id="diversosTbody"></tbody>
                <tfoot><tr><td>Total</td><td id="diversosTotal" colspan="3">R$ 0,00</td></tr></tfoot>
            </table>
        </div>
        <div class="grid-item full-width-item">
            <div class="card-header-wrapper"><h2><i class="fa-solid fa-calendar-alt"></i> Vencimento das parcelas</h2></div>
            <table id="summaryTable">
                <thead><tr><th>Descrição</th><th>Banco/Cartão</th><th>Valor</th><th>Parcela</th><th>Mês Final</th></tr></thead>
                <tbody></tbody>
                <tfoot><tr><td colspan="2">Total Parcelado Pendente</td><td id="installmentsTotal" colspan="3">R$ 0,00</td></tr></tfoot>
            </table>
        </div>
    </div>
</div>

<div id="status"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDQOGFiqafMZh0ha6XW62P1DpIKJE8TBYc",
        authDomain: "agenda-online-7b71c.firebaseapp.com",
        databaseURL: "https://agenda-online-7b71c-default-rtdb.firebaseio.com",
        projectId: "agenda-online-7b71c",
        storageBucket: "agenda-online-7b71c.firebasestorage.app",
        messagingSenderId: "28125733214",
        appId: "1:28125733214:web:162d1cce5d14f55c24afcf"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let current_date = new Date();
    let debounceTimer;

    const ui = {
        overlay: document.getElementById("login-overlay"),
        passcodeInput: document.getElementById("passcode-input"),
        loginBtn: document.getElementById("login-button"),
        loginMessage: document.getElementById("login-message"),
        container: document.querySelector(".container"),
        monthYear: document.getElementById("currentMonthYear"),
        totalGeral: document.getElementById("totalGeral"),
        status: document.getElementById("status"),
        importFile: document.getElementById("importFile"),
        tbodies: {
            fixed: document.getElementById("fixedTbody"),
            nubank: document.getElementById("nubankTbody"),
            c6: document.getElementById("c6Tbody"),
            diversos: document.getElementById("diversosTbody")
        }
    };

    // Sistema de login modificado
    get(ref(database, "passcode")).then(snap => {
        const storedCode = snap.val();
        
        if (!storedCode) {
            // Não existe senha no Firebase - solicitar criação de nova senha
            ui.loginMessage.textContent = "Crie uma nova senha de 4 dígitos:";
            ui.loginBtn.textContent = "Criar Senha";
            
            const createPassword = async () => {
                const newPass = ui.passcodeInput.value;
                if (newPass.length === 4 && /^\d{4}$/.test(newPass)) {
                    await set(ref(database, "passcode"), newPass);
                    ui.overlay.style.display = "none";
                    ui.container.style.display = "block";
                    startApp();
                } else {
                    ui.passcodeInput.value = "";
                    ui.passcodeInput.focus();
                }
            };
            
            ui.loginBtn.onclick = createPassword;
            ui.passcodeInput.onkeyup = e => {
                if (e.key === "Enter") createPassword();
            };
        } else {
            // Existe senha no Firebase - solicitar autenticação
            ui.loginMessage.textContent = "Digite o código de acesso para continuar.";
            ui.loginBtn.textContent = "Acessar Sistema";
            
            const login = () => {
                if (ui.passcodeInput.value === storedCode) {
                    ui.overlay.style.display = "none";
                    ui.container.style.display = "block";
                    startApp();
                } else {
                    ui.passcodeInput.value = "";
                    ui.passcodeInput.focus();
                }
            };
            
            ui.loginBtn.onclick = login;
            ui.passcodeInput.onkeyup = e => {
                if (e.key === "Enter") login();
            };
        }
        
        ui.passcodeInput.focus();
    });

    function startApp() {
        updateMonthDisplay();
        loadData();
        setupEvents();
    }

    function setupEvents() {
        document.getElementById("prevMonthBtn").onclick = () => { current_date.setMonth(current_date.getMonth() - 1); refresh(); };
        document.getElementById("nextMonthBtn").onclick = () => { current_date.setMonth(current_date.getMonth() + 1); refresh(); };
        document.getElementById("todayBtn").onclick = () => { current_date = new Date(); refresh(); };
        document.getElementById("clearAllBtn").onclick = clearMonth;
        document.getElementById("saveBtn").onclick = exportBackup;
        document.getElementById("restoreBtn").onclick = () => ui.importFile.click();
        ui.importFile.onchange = importBackup;

        Object.keys(ui.tbodies).forEach(k => {
            const tb = ui.tbodies[k];
            tb.addEventListener("input", e => { if(e.target.tagName === "TD") { ensureEmptyRow(tb); debouncedSave(); } });
            tb.addEventListener("focusout", e => { 
                if(e.target.cellIndex === 1) formatCurrency(e.target);
                compactAndSave();
            });
        });
    }

    function refresh() { updateMonthDisplay(); loadData(); }

    function updateMonthDisplay() {
        const m = current_date.toLocaleString("pt-BR", { month: "long" });
        ui.monthYear.textContent = `${m.charAt(0).toUpperCase() + m.slice(1)} de ${current_date.getFullYear()}`;
    }

    function getMonthKey(date) {
        return `${date.getFullYear()}_${(date.getMonth() + 1).toString().padStart(2, '0')}`;
    }

    async function loadData() {
        const key = getMonthKey(current_date);
        const snap = await get(ref(database, "expenses/" + key));
        
        if(snap.exists()) {
            renderTables(snap.val());
        } else {
            const prevDate = new Date(current_date);
            prevDate.setMonth(prevDate.getMonth() - 1);
            const prevSnap = await get(ref(database, "expenses/" + getMonthKey(prevDate)));
            const newData = prevSnap.exists() ? processNewMonth(prevSnap.val()) : {};
            await set(ref(database, "expenses/" + key), newData);
            renderTables(newData);
        }
    }

    function processNewMonth(old) {
        const d = { fixed: [], nubank: [], c6: [], diversos: [] };
        if(old.fixed) d.fixed = old.fixed.map(r => [r[0], r[1], false]);
        ["nubank", "c6", "diversos"].forEach(k => {
            if(old[k]) {
                old[k].forEach(r => {
                    const m = r[2]?.match(/(\d+)\/(\d+)/);
                    if(m && parseInt(m[1]) < parseInt(m[2])) {
                        d[k].push([r[0], r[1], `${parseInt(m[1])+1}/${m[2]}`, false]);
                    }
                });
            }
        });
        return d;
    }

    function renderTables(data) {
        Object.keys(ui.tbodies).forEach(k => {
            const tb = ui.tbodies[k];
            tb.innerHTML = "";
            (data[k] || []).forEach(rowData => addRow(tb, rowData));
            ensureEmptyRow(tb);
        });
        updateTotals();
    }

    function addRow(tbody, data = []) {
        const tr = tbody.insertRow();
        const cols = (tbody.id === "fixedTbody") ? 2 : 3;
        for(let i=0; i<cols; i++) {
            const td = tr.insertCell();
            td.contentEditable = true;
            td.textContent = data[i] || "";
        }
        const ctd = tr.insertCell();
        ctd.style.textAlign = "center";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!data[cols];
        cb.onchange = debouncedSave;
        ctd.appendChild(cb);
    }

    function ensureEmptyRow(tb) {
        const last = tb.rows[tb.rows.length - 1];
        if(!last || Array.from(last.cells).slice(0,-1).some(c => c.textContent.trim() !== "")) addRow(tb);
    }

    function compactAndSave() {
        Object.keys(ui.tbodies).forEach(k => {
            const tb = ui.tbodies[k];
            Array.from(tb.rows).forEach((r, idx) => {
                const textCells = Array.from(r.cells).slice(0,-1);
                const isEmpty = textCells.every(c => c.textContent.trim() === "");
                if(isEmpty && idx < tb.rows.length - 1) r.remove();
            });
        });
        debouncedSave();
    }

    function debouncedSave() {
        clearTimeout(debounceTimer);
        showStatus("Processando...");
        debounceTimer = setTimeout(save, 800);
    }

    async function save() {
        const key = getMonthKey(current_date);
        const data = {};
        Object.keys(ui.tbodies).forEach(k => {
            data[k] = Array.from(ui.tbodies[k].rows)
                .map(tr => {
                    const r = Array.from(tr.cells).slice(0,-1).map(c => c.textContent.trim());
                    r.push(tr.cells[tr.cells.length-1].querySelector("input").checked);
                    return r;
                }).filter(r => r.slice(0,-1).some(t => t !== ""));
        });
        await set(ref(database, "expenses/" + key), data);
        updateTotals();
        showStatus("Dados Salvos!");
    }

    function updateTotals() {
        let geral = 0;
        let parcList = [];
        const sumTable = document.getElementById("summaryTable").tBodies[0];
        sumTable.innerHTML = "";

        Object.keys(ui.tbodies).forEach(k => {
            let sub = 0;
            Array.from(ui.tbodies[k].rows).forEach(tr => {
                const v = parseVal(tr.cells[1].textContent);
                sub += v;
                if(k !== "fixed") {
                    const p = tr.cells[2].textContent;
                    const m = p.match(/(\d+)\/(\d+)/);
                    if(m) {
                        const rest = parseInt(m[2]) - parseInt(m[1]);
                        const dFinal = new Date(current_date); 
                        dFinal.setMonth(dFinal.getMonth() + rest);
                        
                        const mStr = dFinal.toLocaleString("pt-BR", { month: "long" });
                        const finalStr = `${mStr.charAt(0).toUpperCase() + mStr.slice(1)}/${dFinal.getFullYear()}`;
                        
                        const bankName = k === "nubank" ? "NUBANK" : k === "c6" ? "C6" : "DIVERSOS";
                        
                        parcList.push({
                            desc: tr.cells[0].textContent,
                            bank: bankName,
                            val: v,
                            parc: p,
                            finalStr: finalStr,
                            finalDate: dFinal.getTime()
                        });
                    }
                }
            });
            const el = document.getElementById(k + "Total");
            if(el) el.textContent = sub.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
            geral += sub;
        });

        parcList.sort((a, b) => a.finalDate - b.finalDate);
        parcList.forEach(item => {
            const sr = sumTable.insertRow();
            sr.insertCell().textContent = item.desc;
            sr.insertCell().textContent = item.bank;
            sr.insertCell().textContent = item.val.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
            sr.insertCell().textContent = item.parc;
            sr.insertCell().textContent = item.finalStr;
        });

        ui.totalGeral.textContent = geral.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        const pTotal = parcList.reduce((acc, curr) => acc + curr.val, 0);
        document.getElementById("installmentsTotal").textContent = pTotal.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    async function clearMonth() {
        if(!confirm("Deseja apagar todos os registros deste mês?")) return;
        const key = getMonthKey(current_date);
        await remove(ref(database, "expenses/" + key));
        Object.keys(ui.tbodies).forEach(k => { ui.tbodies[k].innerHTML = ""; ensureEmptyRow(ui.tbodies[k]); });
        updateTotals();
        showStatus("Mês limpo!");
    }

    function exportBackup() {
        get(ref(database, "expenses")).then(snap => {
            const b = new Blob([JSON.stringify(snap.val(), null, 2)], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(b);
            a.download = `backup_financeiro_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        });
    }

    function importBackup(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                if(confirm("ATENÇÃO: Isso apagará todos os dados atuais e restaurará os dados do arquivo. Confirmar?")) {
                    await set(ref(database, "expenses"), data);
                    refresh();
                    showStatus("Restauração Concluída!");
                }
            } catch(err) { alert("Arquivo JSON inválido."); }
        };
        reader.readAsText(file);
    }

    function parseVal(v) { return parseFloat(String(v).replace(/[R$\s.]/g, "").replace(",", ".")) || 0; }
    function formatCurrency(td) {
        const v = parseVal(td.textContent);
        if(v > 0) td.textContent = v.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function showStatus(t) { ui.status.textContent = t; ui.status.classList.add("show"); setTimeout(() => ui.status.classList.remove("show"), 2000); }
</script>
</body>
</html>
