<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle de Abastecimento</title>
    <style>
        :root {
            --cor-primaria: #007bff;
            --cor-primaria-foco: #007bff40;
            --cor-perigo: #dc3545;
            --cor-perigo-hover: #c82333;
            --cor-sucesso: #28a745;
            --cor-fundo: #f4f7f6;
            --cor-cartao: #ffffff;
            --cor-texto: #343a40;
            --cor-borda: #dee2e6;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
                sans-serif;
            background-color: var(--cor-fundo);
            margin: 0;
            padding: 20px;
            color: var(--cor-texto);
        }

        h2 {
            text-align: center;
            font-weight: 600;
            color: var(--cor-texto);
            margin-bottom: 24px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: var(--cor-cartao);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            padding: 20px;
        }

        .top-buttons {
            text-align: right;
            margin-bottom: 15px;
        }

        .btn {
            background: var(--cor-perigo);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 9px 16px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: var(--cor-perigo-hover);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        th {
            background: var(--cor-primaria);
            color: white;
            padding: 12px 10px;
            font-weight: 500;
            text-align: center;
        }

        /* Arredondar cantos do cabe√ßalho */
        th:first-child {
            border-top-left-radius: 8px;
        }
        th:last-child {
            border-top-right-radius: 8px;
        }

        td {
            border-bottom: 1px solid var(--cor-borda);
            text-align: center;
            padding: 8px;
        }

        tr:last-child td {
            border-bottom: none;
        }
        
        /* Estilo do Rodap√© (M√©dia Geral) */
        tfoot td {
            border-top: 2px solid var(--cor-primaria);
            padding: 12px 10px;
            font-size: 16px;
            font-weight: bold;
        }

        tfoot td:first-child {
            text-align: right;
        }

        input[type="number"],
        input[type="date"] {
            width: 95%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--cor-borda);
            text-align: center;
            font-size: 14px;
            box-sizing: border-box; /* Importante para o padding n√£o quebrar o layout */
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--cor-primaria);
            box-shadow: 0 0 0 3px var(--cor-primaria-foco);
        }

        /* Remove setas do input number */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        #aviso {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--cor-sucesso);
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 15px;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }

        #aviso.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsivo */
        @media (max-width: 700px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 10px;
            }
            table, thead, tbody, th, td, tr, tfoot {
                display: block;
            }
            thead {
                display: none; /* Cabe√ßalho original oculto */
            }
            tr {
                background: var(--cor-cartao);
                margin-bottom: 10px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                border: 1px solid var(--cor-borda);
            }
            td {
                border: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                border-bottom: 1px dashed var(--cor-borda);
            }
            td:last-child {
                border-bottom: none;
            }
            td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--cor-primaria);
                margin-right: 10px;
            }
            
            /* Ajustes responsivos para o rodap√© */
            tfoot tr {
                border-top: 2px solid var(--cor-primaria);
                margin-top: 15px;
            }
            tfoot td {
                border: none;
                padding: 12px 10px;
            }
            tfoot td[data-label="M√©dia Geral"]::before {
                 content: "M√©dia Geral (Km/L):";
            }
             tfoot td:first-child { /* Oculta o label duplicado */
                display: none;
            }

            input[type="number"],
            input[type="date"] {
                width: 50%; /* Ajuste para caber ao lado do label */
            }
            .top-buttons {
                text-align: center;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <h2>üöó Controle de Abastecimento</h2>

    <div class="container">
        <div class="top-buttons">
            <button class="btn" id="limparTudo">üßπ Limpar Tudo</button>
        </div>
        <table id="tabela">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Data</th>
                    <th>KM</th>
                    <th>Litros</th>
                    <th>Valor (R$)</th>
                    <th>Consumo (Km/L)</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo">
                </tbody>
            <tfoot>
                <tr>
                    <td colspan="5" style="text-align: right;">M√©dia Geral (Km/L):</td>
                    <td id="media-geral" data-label="M√©dia Geral">-</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div id="aviso">Salvo</div>

    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import {
            getDatabase,
            ref,
            set,
            get,
            remove
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        // Configura√ß√£o do Firebase (APENAS UMA VEZ)
        const firebaseConfig = {
            apiKey: "AIzaSyDQOGFiqafMZh0ha6XW62P1DpIKJE8TBYc",
            authDomain: "agenda-online-7b71c.firebaseapp.com",
            databaseURL: "https://agenda-online-7b71c-default-rtdb.firebaseio.com",
            projectId: "agenda-online-7b71c",
            storageBucket: "agenda-online-7b71c.firebasestorage.app",
            messagingSenderId: "28125733214",
            appId: "1:28125733214:web:162d1cce5d14f55c24afcf"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, "controle_abastecimento");

        // Elementos do DOM
        const tbody = document.getElementById("tabela-corpo");
        const aviso = document.getElementById("aviso");
        const btnLimparTudo = document.getElementById("limparTudo");
        const mediaGeralEl = document.getElementById("media-geral");

        const NUM_LINHAS = 10;

        // --- FUN√á√ïES PRINCIPAIS ---

        /**
         * Gera as linhas vazias na tabela
         */
        function gerarLinhas() {
            for (let i = 1; i <= NUM_LINHAS; i++) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td data-label="#">${i}</td>
                    <td data-label="Data"><input type="date" id="data${i}"></td>
                    <td data-label="KM"><input type="number" id="km${i}" placeholder="KM Total"></td>
                    <td data-label="Litros"><input type="number" id="litros${i}" step="0.01" placeholder="Litros"></td>
                    <td data-label="Valor"><input type="number" id="valor${i}" step="0.01" placeholder="R$"></td>
                    <td data-label="Consumo" id="consumo${i}">-</td>
                `;
                tbody.appendChild(tr);
            }
        }

        /**
         * Mostra o aviso de notifica√ß√£o
         */
        function mostrarAviso(mensagem) {
            aviso.textContent = mensagem;
            aviso.classList.add("show");
            setTimeout(() => {
                aviso.classList.remove("show");
            }, 2000);
        }

        /**
         * Calcula o consumo INDIVIDUAL para todas as linhas e atualiza a UI
         */
        function calcularConsumoIndividual() {
            for (let i = 2; i <= NUM_LINHAS; i++) {
                const kmAtual = parseFloat(document.getElementById(`km${i}`).value) || 0;
                const kmAnt = parseFloat(document.getElementById(`km${i - 1}`).value) || 0;
                const litros = parseFloat(document.getElementById(`litros${i}`).value) || 0;

                let consumo = "-";
                // S√≥ calcula se tivermos KM anterior, KM atual maior e litros
                if (litros > 0 && kmAtual > kmAnt && kmAnt > 0) {
                    consumo = ((kmAtual - kmAnt) / litros).toFixed(2);
                }
                document.getElementById(`consumo${i}`).textContent = consumo;
            }
        }

        /**
         * Calcula a M√âDIA GERAL de consumo
         */
        function calcularMediaGeral() {
            let primeiroKm = 0;
            let ultimoKm = 0;
            let totalLitros = 0;
            let primeiroKmIndex = -1;

            // 1. Encontrar o primeiro e √∫ltimo KM v√°lidos
            for (let i = 1; i <= NUM_LINHAS; i++) {
                const km = parseFloat(document.getElementById(`km${i}`).value) || 0;
                if (km > 0) {
                    if (primeiroKm === 0) {
                        primeiroKm = km;
                        primeiroKmIndex = i; // Guarda a linha do primeiro abastecimento
                    }
                    ultimoKm = km;
                }
            }

            // 2. Se n√£o houver pelo menos 2 registros de KM, n√£o h√° como calcular
            if (primeiroKmIndex === -1 || ultimoKm === primeiroKm) {
                mediaGeralEl.textContent = "-";
                return;
            }

            // 3. Somar todos os litros A PARTIR do SEGUNDO registro de KM
            // (pois o primeiro abastecimento s√≥ "inicia" o tanque)
            for (let i = primeiroKmIndex + 1; i <= NUM_LINHAS; i++) {
                 const km = parseFloat(document.getElementById(`km${i}`).value) || 0;
                 const litros = parseFloat(document.getElementById(`litros${i}`).value) || 0;
                 
                 // S√≥ soma litros se houver um KM v√°lido (para n√£o contar litros de linhas vazias no meio)
                 if (km > 0 && litros > 0) {
                    totalLitros += litros;
                 }
            }
            
            // 4. Calcular e exibir
            const totalKmRodado = ultimoKm - primeiroKm;
            if (totalLitros > 0 && totalKmRodado > 0) {
                const media = (totalKmRodado / totalLitros).toFixed(2);
                mediaGeralEl.textContent = media;
            } else {
                mediaGeralEl.textContent = "-";
            }
        }

        /**
         * L√™ todos os dados da tabela, calcula e salva no Firebase
         */
        async function salvarDados() {
            // 1. Calcula o consumo individual
            calcularConsumoIndividual();
            
            // 2. Calcula a m√©dia geral
            calcularMediaGeral();

            // 3. Monta o array de dados para salvar
            const dados = [];
            for (let i = 1; i <= NUM_LINHAS; i++) {
                const data = document.getElementById(`data${i}`).value || "";
                const km = parseFloat(document.getElementById(`km${i}`).value) || 0;
                const litros = parseFloat(document.getElementById(`litros${i}`).value) || 0;
                const valor = parseFloat(document.getElementById(`valor${i}`).value) || 0;
                const consumo = document.getElementById(`consumo${i}`).textContent;

                // Salva 0 como string vazia para limpar o campo
                dados.push({
                    data: data,
                    km: km || "",
                    litros: litros || "",
                    valor: valor || "",
                    consumo: consumo
                });
            }

            // 4. Salva no Firebase
            try {
                await set(dbRef, dados);
                mostrarAviso("‚úÖ Dados salvos!");
            } catch (e) {
                console.error("Erro ao salvar no Firebase:", e);
                mostrarAviso("‚ùå Erro ao salvar.");
            }
        }

        /**
         * Carrega os dados do Firebase ao iniciar a p√°gina
         */
        async function carregarDados() {
            try {
                const snapshot = await get(dbRef);
                if (snapshot.exists()) {
                    const dados = snapshot.val();
                    
                    if (Array.isArray(dados)) {
                        dados.forEach((linha, index) => {
                            const i = index + 1;
                            if (i <= NUM_LINHAS) {
                                document.getElementById(`data${i}`).value = linha.data || "";
                                document.getElementById(`km${i}`).value = linha.km || "";
                                document.getElementById(`litros${i}`).value = linha.litros || "";
                                document.getElementById(`valor${i}`).value = linha.valor || "";
                            }
                        });
                    }
                }
                // Calcula o consumo individual com base nos dados carregados
                calcularConsumoIndividual();
                // Calcula a m√©dia geral com base nos dados carregados
                calcularMediaGeral();
                
                console.log("Dados carregados com sucesso.");

            } catch (e) {
                console.error("Erro ao carregar dados:", e);
                mostrarAviso("‚ùå Erro ao carregar dados.");
            }
        }

        /**
         * Limpa todos os campos da UI e remove do Firebase
         */
        async function limparTudo() {
            if (!confirm("Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.")) {
                return;
            }

            // Limpa UI
            for (let i = 1; i <= NUM_LINHAS; i++) {
                document.getElementById(`data${i}`).value = "";
                document.getElementById(`km${i}`).value = "";
                document.getElementById(`litros${i}`).value = "";
                document.getElementById(`valor${i}`).value = "";
                document.getElementById(`consumo${i}`).textContent = "-";
            }
            mediaGeralEl.textContent = "-"; // Limpa a m√©dia geral tamb√©m

            // Limpa Firebase
            try {
                await remove(dbRef);
                mostrarAviso("üßπ Dados limpos!");
            } catch (e) {
                console.error("Erro ao limpar dados:", e);
                mostrarAviso("‚ùå Erro ao limpar dados.");
            }
        }

        // --- INICIALIZA√á√ÉO E EVENTOS ---

        // 1. Gera as linhas da tabela na tela
        gerarLinhas();

        // 2. Adiciona o listener para salvar (usando 'change' e delega√ß√£o de evento)
        tbody.addEventListener("change", (e) => {
            if (e.target.tagName === "INPUT") {
                // Feature: Preenche data automaticamente ao digitar KM
                const idNum = e.target.id.replace(/\D/g, ""); // Pega s√≥ o n√∫mero do ID
                if (e.target.id.startsWith("km") && idNum) {
                    const dataInput = document.getElementById(`data${idNum}`);
                    if (!dataInput.value) {
                        // Formata a data para o fuso hor√°rio local
                        const dataLocal = new Date();
                        dataLocal.setMinutes(dataLocal.getMinutes() - dataLocal.getTimezoneOffset());
                        dataInput.value = dataLocal.toISOString().split("T")[0];
                    }
                }
                
                // Salva os dados (que agora recalcula tudo)
                salvarDados();
            }
        });

        // 3. Adiciona o listener para o bot√£o de limpar
        btnLimparTudo.addEventListener("click", limparTudo);

        // 4. Carrega os dados existentes assim que a p√°gina √© carregada
        document.addEventListener("DOMContentLoaded", carregarDados);

    </script>
</body>
</html>
